<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../img/favicon.ico">
        <title>getopt()函数 - My Docs</title>
        <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../openMP/openmp/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../getopt_long/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#getopt" class="nav-link">getopt()函数</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="getopt">getopt()函数</h1>
<p>无法使用长参数</p>
<h3 id="1">1 原型</h3>
<pre><code class="language-c++">#include &lt;unistd.h&gt;

extern char *optarg;
extern int optind, opterr, optopt;
int getopt(int argc, char * const argv[], const char *optstring);
</code></pre>
<h4 id="_1">外部变量：</h4>
<p>optarg：若短选项后有参数，则optarg指向该参数
optind：扫描选项时，标识下一个选项的索引；扫描结束后，标识第一个非选项参数索引
opterr：出现不可识别的选项时，getopt将打印错误信息。将opterr设为0,可不打印错误信息。
optopt：存放不可识别的选项至optopt</p>
<h4 id="_2">参数</h4>
<p>argc：参数的个数(main)
argv：参数数组(main)
optstring：短选项字符集合，如 -i -n中的i,n
若选项后面有参数，则选项字符后加:， 对应的参数值保存在外部变量optarg中
如optstring 为"i:a",则表示程序支持两个短选项 -i arg和-a, -i后面须有参数值
当执行./a.out -i filename -a时，optarg指针就指向filename</p>
<h3 id="2">2 描述</h3>
<ol>
<li>
<p>getopt函数的前两个参数，就是main函数的argc和argv，这两者直接传入即可，要考虑的就只剩下第三个参数。</p>
</li>
<li>
<p>optstring的格式举例说明比较方便，例如：</p>
<p>char *optstring = "abcd:e::";
   上面这个optstring在传入之后，getopt函数将依次检查命令行是否指定了 -a， -b， -c及 -d（这需要多次调用getopt函数，直到其返回-1），当检查到上面某一个参数被指定时，函数会返回被指定的参数名称（即该字母）最后一个参数d后面带有冒号，: 表示参数d是可以指定值的，如 -d 100 或 -d user。字符后带两个':'表示该选项带可选参数(参数可有可无)。</p>
</li>
</ol>
<p><code>shell
   ./a.out -a -b -c -d 100 -e
   ./a.out -a -b -c -d 100 -e 200    // e是可选参数，可不带参数</code></p>
<ol>
<li>
<p>optind表示的是下一个将被处理到的参数在argv中的下标值。</p>
</li>
<li>
<p>如果指定opterr = 0的话，在getopt、getopt_long、getopt_long_only遇到错误将不会输出错误信息到标准输出流。</p>
</li>
</ol>
<h3 id="3">3 解析过程</h3>
<p>getopt首先扫描argv[1]到argv[argc-1]，并将选项及参数依次放到argv数组的最左边，非选项参数依次放到argv的最后边
即该函数会改变argv的排列顺序。</p>
<p>如执行程序为:</p>
<pre><code>     0         1    2    3    4  5    6     7  8   9 
$ ./mygetopt file1 -i infile -a -o outfile -v -h file2
</code></pre>
<p>扫描过程中，optind是下一个选项的索引（如-i、-a、-o、-v）, 非选项参数将跳过，同时optind增1。optind初始值为1。
当扫描argv[1]时，为非选项参数，跳过，optind=2; 扫描到-i选项时，后面有参数，下一个将要扫描的选项是-a,则optind更改为4；
扫描到-a选项时，下一个选项是-o，optind=5; 扫描到-o选项时，后面有参数，下一个选项是-v,optind=7; 扫描到-v选项时，下一个
选项是-h，optind=8; 扫描到-h选项时，扫描完了，optind=9</p>
<p>扫描结束后，getopt会将argv数组修改成下面的形式(optstring指定为"i:ao:vh")：</p>
<pre><code>     0       1    2    3  4    5     6  7   8     9
$./mygetopt -i infile -a -o outfile -v -h file1 file2
</code></pre>
<p>同时，optind会指向非选项的第一个参数，如上面，optind将指向file1</p>
<h3 id="4">4 返回值</h3>
<p>若getopt找到短选项字符，则返回该选项字符，如此例中的i a o v h.
若出现不能接受的选项字符或丢失选项参数，则返回?，同时optopt将被设置成相应选项字符；
则后面没有选项字符，则返回-1</p>
<p>注：
getopt()的返回后，如果有选项参数的话optarg指向选项参数，并且变量optind包含下一个argv参数作为对getopt()下一次调用的索引。
变量optopt保存最后一个由getopt()返回的已知的选项。
在调用getopt()之前，将opterr设置为0，这样就可以在getopt()函数发现错误的时候强制它不输出任何消息。</p>
<h3 id="5-example">5 Example</h3>
<h4 id="51-1">5.1 例1</h4>
<pre><code class="language-c++">#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
int main(int argc, char * argv[])
{

    int ch;
    printf(&quot;\n\n&quot;);
    printf(&quot;optind:%d，opterr：%d\n&quot;,optind,opterr);
    printf(&quot;--------------------------\n&quot;);
       while ((ch = getopt(argc, argv, &quot;ab:c:de::&quot;)) != -1)
       {
        printf(&quot;optind: %d\n&quot;, optind);
           switch (ch) 
        {
               case 'a':
                       printf(&quot;HAVE option: -a\n\n&quot;);   
                       break;
               case 'b':
                       printf(&quot;HAVE option: -b\n&quot;); 
                       printf(&quot;The argument of -b is %s\n\n&quot;, optarg);
                       break;
               case 'c':
                       printf(&quot;HAVE option: -c\n&quot;);
                       printf(&quot;The argument of -c is %s\n\n&quot;, optarg);
                       break;
               case 'd':
                   printf(&quot;HAVE option: -d\n&quot;);
                     break;
              case 'e':
                    printf(&quot;HAVE option: -e\n&quot;);
                    printf(&quot;The argument of -e is %s\n\n&quot;, optarg);
                  break;
              case '?':
                       printf(&quot;Unknown option: %c\n&quot;,(char)optopt);
                       break;
               }
       }


}
</code></pre>
<h4 id="52-2">5.2 例2</h4>
<pre><code class="language-c++">static char g_deviceid[32] = {0};

std::string g_serverIP = &quot;172.18.18.18&quot;;
static int g_serverPort = 8888;

void PrintHelp(char* prog)
{
    printf(&quot;%s usage.\n&quot;, prog);
    printf(&quot;eg:\n&quot;);
    printf(&quot;%s -i 172.18.18.18 -p 8888 -s 123456789\n&quot;, prog);
    printf(&quot;-i: ip address, default: 192.168.1.20\n&quot;);
    printf(&quot;-p: port number, default: 8888\n&quot;);
    printf(&quot;-s: serial number, default: 123456789\n&quot;);

}
void ParseArg(int argc, char *argv[])
{
    int ch = 0;

    strcpy(g_deviceid, &quot;123456789&quot;);

    if (argc == 2)
    {
        if (!strcmp(argv[1], &quot;?&quot;) ||
            !strcmp(argv[1], &quot;--help&quot;) ||
            !strcmp(argv[1], &quot;-h&quot;))
        {
            PrintHelp(argv[0]);
            exit(0);
        }
    }

    while ((ch = getopt(argc, argv, &quot;i:p:s:&quot;)) != -1)
    {
        switch (ch)
        {
        case 'i':
            g_serverIP = optarg;
            break;
        case 'p':
            g_serverPort = atoi(optarg);
            break;
        case 's':
            memcpy(g_deviceid, optarg, 32);
            break;
        case '?':
        default:
            PrintHelp(argv[0]);
            exit(0);
            break;
        }
    }
}
</code></pre>
<h4 id="53-3">5.3 例3</h4>
<pre><code class="language-c++">#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;

int main(int argc, char *argv[])
{
    int opt;
    char *optstring = &quot;a:b:c:d&quot;;

    while ((opt = getopt(argc, argv, optstring)) != -1)
    {
        printf(&quot;opt = %c\n&quot;, opt);
        printf(&quot;optarg = %s\n&quot;, optarg);
        printf(&quot;optind = %d\n&quot;, optind);
        printf(&quot;argv[optind - 1] = %s\n\n&quot;,  argv[optind - 1]);
    }

    return 0;
}
</code></pre>
<h3 id="54-4">5.4 例4</h3>
<pre><code class="language-c++">#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;getopt.h&gt;

void print_help(char *program) {
    printf(&quot;%s usage.\n&quot;, program);
    printf(&quot;eg:\n&quot;);
    printf(&quot;%s --from-core 0 --to-core 29 --not-skip-free\n&quot;, program);
    printf(&quot;--from-core num: core info start range, default: 0.\n&quot;);
    printf(&quot;--to-core num: core info end range, default: 29\n&quot;);
    printf(&quot;--not-skip-free: don't skip those the free core, default is skip free core\n&quot;);

}

int main(int argc, char **argv)
{
   unsigned int from_core = 0;
   unsigned int to_core = 20;
   bool skip_free = true;


   int opt = -1;
   int long_option_index = 0;

   // short option, if only use long otpion, use NULL.
   const char *short_opts = &quot;&quot;;

   // long option, if only use short option, use NULL.
   static struct option long_options[] = {  // long option
       {&quot;from-core&quot;, required_argument, NULL, 'f'},
       {&quot;to-core&quot;, required_argument, NULL, 't'},
       {&quot;not-skip-free&quot;, optional_argument, NULL, 'n'},
       {0, 0, 0, 0}
   };

//   while ((ret_val = getopt_long(argc, argv, optstring, long_options, &amp;long_option_index)) != -1)
   while ((opt = getopt_long_only(argc, argv, short_opts, long_options, &amp;long_option_index)) != -1)
   { 
        printf(&quot;opt = %c\n&quot;, opt);
        printf(&quot;optarg = %s\n&quot;, optarg);
        printf(&quot;optind = %d\n&quot;, optind);
        printf(&quot;argv[optind - 1] = %s\n&quot;,  argv[optind - 1]);
        printf(&quot;option_index = %d\n\n&quot;, long_option_index);

        switch(opt)
        {
        case 'f':
            from_core = atoi(optarg);
            break;

        case 't':
            to_core = atoi(optarg);
            break;

        case 'n':
            skip_free = false;
            break;
        case '?':
        default:
            printf(&quot;Argument error.\n\n&quot;);
            print_help(argv[0]);
        }
   }

   return 0;
}
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../js/base.js"></script>
        <script src="../../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
