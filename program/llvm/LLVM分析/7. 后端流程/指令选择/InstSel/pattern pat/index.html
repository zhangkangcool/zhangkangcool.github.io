<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../../../../img/favicon.ico">
        <title>1. Simple Pat&lt; - My Docs</title>
        <link href="../../../../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../../../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../../../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../../../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../../../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../../../../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../llc%20SelectionDag/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../setOperationAction/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#1-simple-pat" class="nav-link">1. Simple Pat&lt;</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#2-complexpattern" class="nav-link">2. ComplexPattern</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="1-simple-pat">1. Simple Pat&lt;</h1>
<h4 id="isdsetcc">ISD::SETCC</h4>
<p><code>SETCC</code>目前没有出现在中括号里如（ISD::SELECT），出现在了Pat&lt;中,然后会继续去选择。如继续选择<code>PPC::EXTRACT_SUBREG</code>和<code>ISD::FCMPUS</code></p>
<pre><code class="language-asm">def : Pat&lt;(ISD::Node), (TargetOpcode::Node)&gt;
def : Pat&lt;(PPCISD::Node), (PPC::Node)&gt;
</code></pre>
<pre><code class="language-asm">let Predicates = [HasFPU] in {
def : Pat&lt;(i1 (setcc f32:$s1, f32:$s2, SETOLT)),
          (EXTRACT_SUBREG (FCMPUS $s1, $s2), sub_lt)&gt;;
def : Pat&lt;(i1 (setcc f32:$s1, f32:$s2, SETLT)),
          (EXTRACT_SUBREG (FCMPUS $s1, $s2), sub_lt)&gt;;
def : Pat&lt;(i1 (setcc f32:$s1, f32:$s2, SETOGT)),
          (EXTRACT_SUBREG (FCMPUS $s1, $s2), sub_gt)&gt;;
def : Pat&lt;(i1 (setcc f32:$s1, f32:$s2, SETGT)),
          (EXTRACT_SUBREG (FCMPUS $s1, $s2), sub_gt)&gt;;
def : Pat&lt;(i1 (setcc f32:$s1, f32:$s2, SETOEQ)),
          (EXTRACT_SUBREG (FCMPUS $s1, $s2), sub_eq)&gt;;
def : Pat&lt;(i1 (setcc f32:$s1, f32:$s2, SETEQ)),
          (EXTRACT_SUBREG (FCMPUS $s1, $s2), sub_eq)&gt;;
def : Pat&lt;(i1 (setcc f32:$s1, f32:$s2, SETUO)),
          (EXTRACT_SUBREG (FCMPUS $s1, $s2), sub_un)&gt;;
</code></pre>
<h4 id="how-to-use-pat">How to use Pat&lt;</h4>
<p><code>Pat&lt;ISD::, PPC::&gt;</code></p>
<p>Example: How to select <code>isd::extract_vector_elt</code></p>
<pre><code class="language-asm">ISEL: Starting selection on root node: t26: i32 = extract_vector_elt t104, Constant:i64&lt;0&gt;
 6332 ISEL: Starting pattern match
 6333   Initial Opcode index to 34955
 6334   Skipped scope entry (due to false predicate) at index 34959, continuing at 35627
 6335   TypeSwitch[i32] from 35631 to 35741
 6336   Skipped scope entry (due to false predicate) at index 35748, continuing at 35780
 6337   Skipped scope entry (due to false predicate) at index 35781, continuing at 35812
 6338   Created node: t227: i64 = LI8 TargetConstant:i64&lt;0&gt;
 6339 Creating new machine node: t229: i64 = VEXTUWLX t227, t104
 6340   Created node: t229: i64 = VEXTUWLX t227, t104
 6341   Morphed node: t26: i32 = EXTRACT_SUBREG t229, TargetConstant:i32&lt;1&gt;
 6342 ISEL: Match complete!

</code></pre>
<pre><code class="language-asm"> def : Pat&lt;(i32 (vector_extract v4i32:$S, 0)),
            (i32 (EXTRACT_SUBREG (VEXTUWLX (LI8 0), $S), sub_32))&gt;;
</code></pre>
<hr />
<h1 id="2-complexpattern">2. ComplexPattern</h1>
<p>指令定义时中括号匹配规则中所使用的复杂操作数，利用C++函数进行各种逻辑判断。</p>
<p>基于<code>ComplexPattern</code>的操作数匹配。利用 <code>ComplexPattern</code>，可以支持复杂的操作数模式，但需编写 C++实现的模式匹配函数。需在<code>ISelDAGToDAG.cpp</code>中实现对应的函数。</p>
<p>模式匹配函数返回的一定是<code>bool</code>类型，说明什么以条件可以匹配到这个pattern。</p>
<h4 id="21-x86">2.1 X86</h4>
<p>以下  <code>selectLEA64_32Addr</code>的代码<code>X86</code></p>
<pre><code class="language-c++">
// Define X86-specific addressing mode.
// 定义复杂pattern对应的
def addr      : ComplexPattern&lt;iPTR, 5, &quot;selectAddr&quot;, [], [SDNPWantParent]&gt;;
def lea32addr : ComplexPattern&lt;i32, 5, &quot;selectLEAAddr&quot;,
                               [add, sub, mul, X86mul_imm, shl, or, frameindex],
                               []&gt;;
// In 64-bit mode 32-bit LEAs can use RIP-relative addressing.
def lea64_32addr : ComplexPattern&lt;i32, 5, &quot;selectLEA64_32Addr&quot;,
                                  [add, sub, mul, X86mul_imm, shl, or,
                                   frameindex, X86WrapperRIP],
                                  []&gt;;

// 匹配复杂pattern
def LEA64_32r : I&lt;0x8D, MRMSrcMem,
                  (outs GR32:$dst), (ins lea64_32mem:$src),
                  &quot;lea{l}\t{$src|$dst}, {$dst|$src}&quot;,
                  [(set GR32:$dst, lea64_32addr:$src)]&gt;,
                  OpSize32, Requires&lt;[In64BitMode]&gt;;
</code></pre>
<pre><code class="language-c++">bool X86DAGToDAGISel::selectLEA64_32Addr(SDValue N, SDValue &amp;Base,
                                         SDValue &amp;Scale, SDValue &amp;Index,
                                         SDValue &amp;Disp, SDValue &amp;Segment) {
  ...                                        
}
</code></pre>
<h4 id="22-powerpc">2.2 PowerPC</h4>
<pre><code class="language-c++">1031 // Define PowerPC specific addressing mode.
1032
1033 // d-form
1034 def iaddr    : ComplexPattern&lt;iPTR, 2, &quot;SelectAddrImm&quot;,     [], []&gt;;  // &quot;stb&quot;
1035 // ds-form
1036 def iaddrX4  : ComplexPattern&lt;iPTR, 2, &quot;SelectAddrImmX4&quot;,   [], []&gt;;  // &quot;std&quot;
1037 // dq-form
1038 def iaddrX16 : ComplexPattern&lt;iPTR, 2, &quot;SelectAddrImmX16&quot;,  [], []&gt;;  // &quot;stxv&quot;
1039
1040 // Below forms are all x-form addressing mode, use three different ones so we
1041 // can make a accurate check for x-form instructions in ISEL.
1042 // x-form addressing mode whose associated displacement form is D.
1043 def xaddr  : ComplexPattern&lt;iPTR, 2, &quot;SelectAddrIdx&quot;,     [], []&gt;;    // &quot;stbx&quot;
1044 // x-form addressing mode whose associated displacement form is DS.
1045 def xaddrX4 : ComplexPattern&lt;iPTR, 2, &quot;SelectAddrIdxX4&quot;,    [], []&gt;;  // &quot;stdx&quot;
1046 // x-form addressing mode whose associated displacement form is DQ.
1047 def xaddrX16 : ComplexPattern&lt;iPTR, 2, &quot;SelectAddrIdxX16&quot;,   [], []&gt;; // &quot;stxvx&quot;
1048
1049 def xoaddr : ComplexPattern&lt;iPTR, 2, &quot;SelectAddrIdxOnly&quot;,[], []&gt;;
1050
1051 // The address in a single register. This is used with the SjLj
1052 // pseudo-instructions.
1053 def addr   : ComplexPattern&lt;iPTR, 1, &quot;SelectAddr&quot;,[], []&gt;;
1054
1055 /// This is just the offset part of iaddr, used for preinc.
1056 def iaddroff : ComplexPattern&lt;iPTR, 1, &quot;SelectAddrImmOffs&quot;, [], []&gt;;
1057
1058 // PC Relative Address
1059 def pcreladdr : ComplexPattern&lt;iPTR, 1, &quot;SelectAddrPCRel&quot;, [], []&gt;;
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../../../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../../../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../../../../js/base.js"></script>
        <script src="../../../../../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
