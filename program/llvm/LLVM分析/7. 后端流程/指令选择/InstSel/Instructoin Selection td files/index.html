<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../../../../img/favicon.ico">
        <title>PPCInstrFormats.td - My Docs</title>
        <link href="../../../../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../../../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../../../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../../../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../../../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../../../../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Instruction%20Format/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../inst%20define/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#ppcinstrformatstd" class="nav-link">PPCInstrFormats.td</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#_1" class="nav-link">指令描述类提供获得指令属性的方法</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#instruction" class="nav-link">Instruction</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#_2" class="nav-link">伪指令/伪结点</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#_3" class="nav-link">函数</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="ppcinstrformatstd">PPCInstrFormats.td</h1>
<p>在此文件中，会定义class I和class I2,各种Form都会继承这2个类。这两个类中可以设置各个Form的默认属性。</p>
<p>只有class I和class I2继承自class Instructoin。</p>
<pre><code class="language-c++">class I&lt;bits&lt;6&gt; opcode, dag OOL, dag IOL, string asmstr, InstrItinClass itin&gt;
        : Instruction {
  field bits&lt;32&gt; Inst;
  ...
}

// Two joined instructions; used to emit two adjacent instructions as one.
// The itinerary from the first instruction is used for scheduling and
// classification.
class I2&lt;bits&lt;6&gt; opcode1, bits&lt;6&gt; opcode2, dag OOL, dag IOL, string asmstr,
         InstrItinClass itin&gt;
        : Instruction {
  field bits&lt;64&gt; Inst;
  field bits&lt;64&gt; SoftFail = 0;
  ...
}

// Pseudo-instructions for alternate assembly syntax (never used by codegen).
// These are aliases that require C++ handling to convert to the target
// instruction, while InstAliases can be handled directly by tblgen.
class PPCAsmPseudo&lt;string asm, dag iops&gt;
  : Instruction {
  let Namespace = &quot;PPC&quot;;
  bit PPC64 = 0;  // Default value, override with isPPC64

  let OutOperandList = (outs);
  let InOperandList = iops;
  let Pattern = [];
  let AsmString = asm;
  let isAsmParserOnly = 1;
  let isPseudo = 1;
  let hasNoSchedulingInfo = 1;
}

</code></pre>
<p>大量指令Form从class I继承来。</p>
<pre><code class="language-c++">class BForm_2&lt;bits&lt;6&gt; opcode, bits&lt;5&gt; bo, bits&lt;5&gt; bi, bit aa, bit lk,
              dag OOL, dag IOL, string asmstr&gt;
  : I&lt;opcode, OOL, IOL, asmstr, IIC_BrB&gt; {
  bits&lt;14&gt; BD;

  let Inst{6-10}  = bo;
  let Inst{11-15} = bi;
  let Inst{16-29} = BD;
  let Inst{30}    = aa;
  let Inst{31}    = lk;
}
</code></pre>
<p>如果要加指令描述，可以参考<code>PPC970_Single</code> </p>
<p><code>bit RC = 0;</code>,RC是指令中的一个位。会用来匹配指令。</p>
<p>指令位和指令属性是不一样的。</p>
<pre><code class="language-shell">会出现在指令定义的尖括号之外
517 // PowerPC Flag Definitions.
 518
 519 class isPPC64 { bit PPC64 = 1; }
 520 class isDOT   { bit RC = 1; }
 521
 522 class RegConstraint&lt;string C&gt; {
 523   string Constraints = C;
 524 }
 525 class NoEncode&lt;string E&gt; {
 526   string DisableEncoding = E;
 527 }
</code></pre>
<pre><code class="language-shell">268 class DForm_2&lt;bits&lt;6&gt; opcode, dag OOL, dag IOL, string asmstr,
 269               InstrItinClass itin, list&lt;dag&gt; pattern&gt;
 270   : DForm_base&lt;opcode, OOL, IOL, asmstr, itin, pattern&gt; {
 271
 272   // Even though ADDICo does not really have an RC bit, provide
 273   // the declaration of one here so that isDOT has something to set.
 274   bit RC = 0;
 275 }

 2344 def ADDIC  : DForm_2&lt;12, (outs gprc:$rD), (ins gprc:$rA, s16imm:$imm),
2345                      &quot;addic $rD, $rA, $imm&quot;, IIC_IntGeneral,
2346                      [(set i32:$rD, (addc i32:$rA, imm32SExt16:$imm))]&gt;,
2347                      RecFormRel, PPC970_DGroup_Cracked;
2348 let Defs = [CARRY, CR0] in
2349 def ADDICo : DForm_2&lt;13, (outs gprc:$rD), (ins gprc:$rA, s16imm:$imm),
2350                      &quot;addic. $rD, $rA, $imm&quot;, IIC_IntGeneral,
2351                      []&gt;, isDOT, RecFormRel;
2352 }
</code></pre>
<hr />
<h2 id="_1">指令描述类提供获得指令属性的方法</h2>
<p><code>./include/llvm/MC/MCInstrDesc.h</code></p>
<pre><code>class MCInstrDesc {
  isSelect();
  mayLoad();
  mayStrore();
}
</code></pre>
<h4 id="usage">Usage</h4>
<pre><code class="language-c++">const MCInstrDesc &amp;MCID = DAG.TII-&gt;get(Opcode);

isLoad  = MCID.mayLoad();
isStore = MCID.mayStore();

</code></pre>
<p>​                                              </p>
<h1 id="instruction">Instruction</h1>
<p>PPC指令一定是从class I或class I2继续而来。可以在<code>llvm/build/lib/Target/PowerPC/PPCGenInstrInfo.inc</code>检查某个符号是不是指令。</p>
<p>定义在<code>/home/shkzhang/llvm/llvm/include/llvm/Target/Target.td</code></p>
<pre><code class="language-c++">408 class InstructionEncoding {
 409   // Size of encoded instruction.
 410   int Size;
 411
 412   // The &quot;namespace&quot; in which this instruction exists, on targets like ARM
 413   // which multiple ISA namespaces exist.
 414   string DecoderNamespace = &quot;&quot;;
 415
 416   // List of predicates which will be turned into isel matching code.
 417   list&lt;Predicate&gt; Predicates = [];
 418
 419   string DecoderMethod = &quot;&quot;;
 420
 421   // Is the instruction decoder method able to completely determine if the
 422   // given instruction is valid or not. If the TableGen definition of the
 423   // instruction specifies bitpattern A??B where A and B are static bits, the
 424   // hasCompleteDecoder flag says whether the decoder method fully handles the
 425   // ?? space, i.e. if it is a final arbiter for the instruction validity.
 426   // If not then the decoder attempts to continue decoding when the decoder
 427   // method fails.
 428   //
 429   // This allows to handle situations where the encoding is not fully
 430   // orthogonal. Example:
 431   // * InstA with bitpattern 0b0000????,
 432   // * InstB with bitpattern 0b000000?? but the associated decoder method
 433   //   DecodeInstB() returns Fail when ?? is 0b00 or 0b11.
 434   //
 435   // The decoder tries to decode a bitpattern that matches both InstA and
 436   // InstB bitpatterns first as InstB (because it is the most specific
 437   // encoding). In the default case (hasCompleteDecoder = 1), when
 438   // DecodeInstB() returns Fail the bitpattern gets rejected. By setting
 439   // hasCompleteDecoder = 0 in InstB, the decoder is informed that
 440   // DecodeInstB() is not able to determine if all possible values of ?? are
 441   // valid or not. If DecodeInstB() returns Fail the decoder will attempt to
 442   // decode the bitpattern as InstA too.
 443   bit hasCompleteDecoder = 1;
 444 }

455 //===----------------------------------------------------------------------===//
 456 // Instruction set description - These classes correspond to the C++ classes in
 457 // the Target/TargetInstrInfo.h file.
 458 //
 459 class Instruction : InstructionEncoding {
 460   string Namespace = &quot;&quot;;
 461
 462   dag OutOperandList;       // An dag containing the MI def operand list.
 463   dag InOperandList;        // An dag containing the MI use operand list.
 464   string AsmString = &quot;&quot;;    // The .s format to print the instruction with.
 465
 466   // Allows specifying a canonical InstructionEncoding by HwMode. If non-empty,
 467   // the Inst member of this Instruction is ignored.
 468   EncodingByHwMode EncodingInfos;
 469
 470   // Pattern - Set to the DAG pattern for this instruction, if we know of one,
 471   // otherwise, uninitialized.
 472   list&lt;dag&gt; Pattern;
 473
 474   // The follow state will eventually be inferred automatically from the
 475   // instruction pattern.
 476
 477   list&lt;Register&gt; Uses = []; // Default to using no non-operand registers
 478   list&lt;Register&gt; Defs = []; // Default to modifying no non-operand registers
 479
 480   // Predicates - List of predicates which will be turned into isel matching
 481   // code.
 482   list&lt;Predicate&gt; Predicates = [];
 483
 484   // Size - Size of encoded instruction, or zero if the size cannot be determined
 485   // from the opcode.
 486   int Size = 0;
 487
 488   // Code size, for instruction selection.
 489   // FIXME: What does this actually mean?
 490   int CodeSize = 0;
 491
 492   // Added complexity passed onto matching pattern.
 493   int AddedComplexity  = 0;
 494
 495   // Indicates if this is a pre-isel opcode that should be
 496   // legalized/regbankselected/selected.
 497   bit isPreISelOpcode = 0;
 498
 499   // These bits capture information about the high-level semantics of the
 500   // instruction.
 501   bit isReturn     = 0;     // Is this instruction a return instruction?
 502   bit isBranch     = 0;     // Is this instruction a branch instruction?
   ...
 }
</code></pre>
<h1 id="_2">伪指令/伪结点</h1>
<p>只用于吃assembly syntax文件，然后映射到另外的指令，一般是用于alias。不会由codegen产生。不用关心其标志，但要设好，他映射到的指令的标志。</p>
<pre><code class="language-asm">// Pseudo-instructions for alternate assembly syntax (never used by codegen).
// These are aliases that require C++ handling to convert to the target
// instruction, while InstAliases can be handled directly by tblgen.
class PPCAsmPseudo&lt;string asm, dag iops&gt;
  : Instruction {
  let Namespace = &quot;PPC&quot;;
  bit PPC64 = 0;  // Default value, override with isPPC64

  let OutOperandList = (outs);
  let InOperandList = iops;
  let Pattern = [];
  let AsmString = asm;
  let isAsmParserOnly = 1;
  let isPseudo = 1;
  let hasNoSchedulingInfo = 1;

  // If an instruction doesn't set the hasSideEffects flag and doesn't have
  // match pattern, the llvm-tblgen will set its hasSideEffects flag as true. In
  // fact, most of instructions don't have SideEffects, it's better to set it as
  // false by default and explicit set it as true for the instruction which
  // really requires.
  bit hasSideEffects = 0;
}

2306 let Defs = [CARRY] in
2307 def ADDIC  : DForm_2&lt;12, (outs gprc:$rD), (ins gprc:$rA, s16imm:$imm),
2308                      &quot;addic $rD, $rA, $imm&quot;, IIC_IntGeneral,
2309                      [(set i32:$rD, (addc i32:$rA, imm32SExt16:$imm))]&gt;,
2310                      RecFormRel, PPC970_DGroup_Cracked;
2311 let Defs = [CARRY, CR0] in
2312 def ADDICo : DForm_2&lt;13, (outs gprc:$rD), (ins gprc:$rA, s16imm:$imm),
2313                      &quot;addic. $rD, $rA, $imm&quot;, IIC_IntGeneral,
2314                      []&gt;, isDOT, RecFormRel;
2315 }

def SUBIC : PPCAsmPseudo&lt;&quot;subic $rA, $rB, $imm&quot;,
                         (ins gprc:$rA, gprc:$rB, s16imm:$imm)&gt;;
def SUBICo : PPCAsmPseudo&lt;&quot;subic. $rA, $rB, $imm&quot;,
                          (ins gprc:$rA, gprc:$rB, s16imm:$imm)&gt;;
</code></pre>
<p><code>./AsmParser/PPCAsmParser.cpp</code></p>
<pre><code class="language-c++">794   case PPC::SUBIC: {
 795     MCInst TmpInst;
 796     TmpInst.setOpcode(PPC::ADDIC);
 797     TmpInst.addOperand(Inst.getOperand(0));
 798     TmpInst.addOperand(Inst.getOperand(1));
 799     addNegOperand(TmpInst, Inst.getOperand(2), getContext());
 800     Inst = TmpInst;
 801     break;
 802   }
 803   case PPC::SUBICo: {
 804     MCInst TmpInst;
 805     TmpInst.setOpcode(PPC::ADDICo);
 806     TmpInst.addOperand(Inst.getOperand(0));
 807     TmpInst.addOperand(Inst.getOperand(1));
 808     addNegOperand(TmpInst, Inst.getOperand(2), getContext());
 809     Inst = TmpInst;
 810     break;
 811   }
</code></pre>
<h1 id="_3">函数</h1>
<p>使用<code>!func_name()</code>在<code>td</code>文件中执行函数。</p>
<p><code>strconcat()</code>函数用于连接，</p>
<p><code>class StoreRetvalInst&lt;&gt; :  NVPTXInst&lt;&gt;;</code> 用于批量定义类似的指令，其实不用<code>class</code>，单独使用<code>def MyInst: NVPTXInst&lt;&gt;</code>也是可以的,<code>strconcat()</code>也可用于普通的指令中（非class）。</p>
<pre><code class="language-c++">  class StoreRetvalInst&lt;NVPTXRegClass regclass, string opstr&gt; :
        NVPTXInst&lt;(outs), (ins regclass:$val, i32imm:$a),
                  !strconcat(&quot;st.param&quot;, opstr, &quot; \t[func_retval0+$a], $val;&quot;),
                  []&gt;;
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../../../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../../../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../../../../js/base.js"></script>
        <script src="../../../../../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
