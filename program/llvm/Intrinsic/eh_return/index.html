<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../img/favicon.ico">
        <title>Clang - My Docs</title>
        <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Intrinsic/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../setrnd/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#clang" class="nav-link">Clang</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#llvm" class="nav-link">llvm</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="clang">Clang</h1>
<h3 id="1-clangincludeclangbasicbuiltinsdef">1 clang/include/clang/Basic/Builtins.def</h3>
<pre><code class="language-c++">clang/include/clang/Basic/Builtins.def:BUILTIN(__builtin_return_address, &quot;v*IUi&quot;, &quot;n&quot;)
clang/include/clang/Basic/Builtins.def:BUILTIN(__builtin_extract_return_addr, &quot;v*v*&quot;, &quot;n&quot;)
clang/include/clang/Basic/Builtins.def:BUILTIN(__builtin_eh_return_data_regno, &quot;iIi&quot;, &quot;nc&quot;)
clang/include/clang/Basic/Builtins.def:BUILTIN(__builtin_eh_return, &quot;vzv*&quot;, &quot;r&quot;) // FIXME: Takes intptr_t, not size_t!
</code></pre>
<h3 id="2-clanglibcodegencgbuiltincpp">2 <code>clang/lib/CodeGen/CGBuiltin.cpp</code>中做一些类型检测等（非必须的步骤）</h3>
<p>C中使用<code>__builtin_eh_return</code>，根据情况产生<code>Intrinsic::eh_return_i32</code>或是<code>Intrinsic::eh_return_i64</code>.</p>
<pre><code class="language-c++"> 1645 RValue CodeGenFunction::EmitBuiltinExpr(const GlobalDecl GD, unsigned BuiltinID,
 1646                                         const CallExpr *E,
 1647                                         ReturnValueSlot ReturnValue) {
 2354   case Builtin::BI__builtin_trap:
 2355     return RValue::get(EmitTrapCall(Intrinsic::trap));
   ...
 2857   case Builtin::BI__builtin_eh_return: {
 2858     Value *Int = EmitScalarExpr(E-&gt;getArg(0));
 2859     Value *Ptr = EmitScalarExpr(E-&gt;getArg(1));
 2860
 2861     llvm::IntegerType *IntTy = cast&lt;llvm::IntegerType&gt;(Int-&gt;getType());
 2862     assert((IntTy-&gt;getBitWidth() == 32 || IntTy-&gt;getBitWidth() == 64) &amp;&amp;
 2863            &quot;LLVM's __builtin_eh_return only supports 32- and 64-bit variants&quot;);
 2864     Function *F =
 2865         CGM.getIntrinsic(IntTy-&gt;getBitWidth() == 32 ? Intrinsic::eh_return_i32
 2866                                                     : Intrinsic::eh_return_i64);
 2867     Builder.CreateCall(F, {Int, Ptr});
 2868     Builder.CreateUnreachable();
 2869
 2870     // We do need to preserve an insertion point.
 2871     EmitBlock(createBasicBlock(&quot;builtin_eh_return.cont&quot;));
 2872
 2873     return RValue::get(nullptr);
 2874   } 

</code></pre>
<h3 id="3-case">3 case</h3>
<p>case from <code>llvm/clang/test/Sema/builtins.c</code></p>
<pre><code class="language-c++">int test13() {
  int i = 0;
  __builtin_eh_return(0, 0); // no warning, eh_return never returns.
  int volatile j = 1;
  return j;
}
</code></pre>
<p>we will get below ll:</p>
<pre><code class="language-c++">; ModuleID = 'sim.c'
source_filename = &quot;sim.c&quot;
target datalayout = &quot;e-m:e-i64:64-n32:64&quot;
target triple = &quot;powerpc64le-unknown-linux-gnu&quot;

; Function Attrs: noinline nounwind optnone
define dso_local signext i32 @test13() #0 {
entry:
  %i = alloca i32, align 4
  %j = alloca i32, align 4
  store i32 0, i32* %i, align 4
  call void @llvm.eh.return.i64(i64 0, i8* null)
  unreachable
}

; Function Attrs: nounwind
declare void @llvm.eh.return.i64(i64, i8*) #1

attributes #0 = { noinline nounwind optnone &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;ppc64le&quot; &quot;target-features&quot;=&quot;+altivec,+bpermd,+crypto,+direct-move,+extdiv,+htm,+power8-vector,+vsx,-power9-vector,-spe&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; }
attributes #1 = { nounwind }

!llvm.module.flags = !{!0}
!llvm.ident = !{!1}

!0 = !{i32 1, !&quot;wchar_size&quot;, i32 4}
!1 = !{!&quot;clang version 12.0.0 (git@github.ibm.com:compiler/llvm-project.git 2abd07930adae08e5b0989325f3710b0c29fc80c)&quot;}
</code></pre>
<hr />
<h1 id="llvm">llvm</h1>
<p><code>Intrinsic::eh_return_i64</code> -&gt; <code>ISD::EH_RETURN</code> -&gt; <code>LowerEH_RETURN</code> -&gt;</p>
<pre><code class="language-c++">void SelectionDAGBuilder::visitIntrinsicCall(const CallInst &amp;I,
                                             unsigned Intrinsic) {
...
  case Intrinsic::eh_return_i32:
  case Intrinsic::eh_return_i64:
    DAG.getMachineFunction().setCallsEHReturn(true);
    DAG.setRoot(DAG.getNode(ISD::EH_RETURN, sdl,
                            MVT::Other,
                            getControlRoot(),
                            getValue(I.getArgOperand(0)),
                            getValue(I.getArgOperand(1))));
    return;
...
}
</code></pre>
<pre><code class="language-c++">SDValue X86TargetLowering::LowerEH_RETURN(SDValue Op, SelectionDAG &amp;DAG) const {
  SDValue Chain     = Op.getOperand(0);
  SDValue Offset    = Op.getOperand(1);
  SDValue Handler   = Op.getOperand(2);
  SDLoc dl      (Op);

  EVT PtrVT = getPointerTy(DAG.getDataLayout());
  const X86RegisterInfo *RegInfo = Subtarget.getRegisterInfo();
  Register FrameReg = RegInfo-&gt;getFrameRegister(DAG.getMachineFunction());
  assert(((FrameReg == X86::RBP &amp;&amp; PtrVT == MVT::i64) ||
          (FrameReg == X86::EBP &amp;&amp; PtrVT == MVT::i32)) &amp;&amp;
         &quot;Invalid Frame Register!&quot;);
  SDValue Frame = DAG.getCopyFromReg(DAG.getEntryNode(), dl, FrameReg, PtrVT);
  Register StoreAddrReg = (PtrVT == MVT::i64) ? X86::RCX : X86::ECX;

  SDValue StoreAddr = DAG.getNode(ISD::ADD, dl, PtrVT, Frame,
                                 DAG.getIntPtrConstant(RegInfo-&gt;getSlotSize(),
                                                       dl));
  StoreAddr = DAG.getNode(ISD::ADD, dl, PtrVT, StoreAddr, Offset);
  Chain = DAG.getStore(Chain, dl, Handler, StoreAddr, MachinePointerInfo());
  Chain = DAG.getCopyToReg(Chain, dl, StoreAddrReg, StoreAddr);

  return DAG.getNode(X86ISD::EH_RETURN, dl, MVT::Other, Chain,
                     DAG.getRegister(StoreAddrReg, PtrVT));
}
</code></pre>
<p>Td define</p>
<pre><code class="language-c++">def X86ehret : SDNode&lt;&quot;X86ISD::EH_RETURN&quot;, SDT_X86EHRET,
                        [SDNPHasChain]&gt;;
</code></pre>
<pre><code class="language-c++">let SchedRW = [WriteSystem] in {
let isTerminator = 1, isReturn = 1, isBarrier = 1,
    hasCtrlDep = 1, isCodeGenOnly = 1 in {
def EH_RETURN   : I&lt;0xC3, RawFrm, (outs), (ins GR32:$addr),
                    &quot;ret\t#eh_return, addr: $addr&quot;,
                    [(X86ehret GR32:$addr)]&gt;, Sched&lt;[WriteJumpLd]&gt;;

}

let isTerminator = 1, isReturn = 1, isBarrier = 1,
    hasCtrlDep = 1, isCodeGenOnly = 1 in {
def EH_RETURN64   : I&lt;0xC3, RawFrm, (outs), (ins GR64:$addr),
                     &quot;ret\t#eh_return, addr: $addr&quot;,
                     [(X86ehret GR64:$addr)]&gt;, Sched&lt;[WriteJumpLd]&gt;;

}
</code></pre>
<h3 id="case">case</h3>
<p><code>cat CodeGen/X86/2008-08-31-EH_RETURN64.ll</code></p>
<pre><code class="language-c++">; Check that eh_return &amp; unwind_init were properly lowered
; RUN: llc &lt; %s -verify-machineinstrs | FileCheck %s

target datalayout = &quot;e-p:64:64:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f32:32:32-f64:64:64-v64:64:64-v128:128:128-a0:0:64-s0:64:64-f80:128:128&quot;
target triple = &quot;x86_64-unknown-linux-gnu&quot;

; CHECK: test
; CHECK: pushq %rbp
; CHECK: movq %rsp, %rbp
; CHECK: popq %rbp
; CHECK: movq %rcx, %rsp
; CHECK: retq # eh_return, addr: %rcx
define i8* @test(i64 %a, i8* %b)  {
entry:
  call void @llvm.eh.unwind.init()
  %foo   = alloca i32
  call void @llvm.eh.return.i64(i64 %a, i8* %b)
  unreachable
}

declare void @llvm.eh.return.i64(i64, i8*)
declare void @llvm.eh.unwind.init()

@b = common global i32 0, align 4
@a = common global i32 0, align 4

; PR14750
; This function contains a normal return as well as eh_return.
; CHECK: _Unwind_Resume_or_Rethrow
define i32 @_Unwind_Resume_or_Rethrow() nounwind uwtable ssp {
entry:
  %0 = load i32, i32* @b, align 4
  %tobool = icmp eq i32 %0, 0
  br i1 %tobool, label %if.end, label %if.then

if.then:                                          ; preds = %entry
  ret i32 0

if.end:                                           ; preds = %entry
  %call = tail call i32 (...) @_Unwind_ForcedUnwind_Phase2() nounwind
  store i32 %call, i32* @a, align 4
  %tobool1 = icmp eq i32 %call, 0
  br i1 %tobool1, label %cond.end, label %cond.true

cond.true:                                        ; preds = %if.end
  tail call void @abort() noreturn nounwind
  unreachable

cond.end:                                         ; preds = %if.end
  tail call void @llvm.eh.return.i64(i64 0, i8* null)
  unreachable
}

declare i32 @_Unwind_ForcedUnwind_Phase2(...)
declare void @abort() noreturn
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../js/base.js"></script>
        <script src="../../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
