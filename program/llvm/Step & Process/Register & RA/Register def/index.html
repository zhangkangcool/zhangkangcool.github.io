<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../../img/favicon.ico">
        <title>Register def - My Docs</title>
        <link href="../../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../PPC%20llvm%20register/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../Tool/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#base-class" class="nav-link">Base class</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#csky" class="nav-link">CSKY</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#registerinfocpp" class="nav-link">RegisterInfo.cpp</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p>https://reviews.llvm.org/D86269#change-xkvgJ0GEdUTo   <code>CSKYRegisterInfo.td</code></p>
<p>https://www.javatt.com/p/43476   // 中文</p>
<h1 id="base-class">Base class</h1>
<p><code>Target.td</code>中所寄存器的各种信息</p>
<pre><code class="language-c++">//===----------------------------------------------------------------------===//
// Register file description - These classes are used to fill in the target
// description classes.

class RegisterClass; // Forward def

class HwMode&lt;string FS&gt; {
  // A string representing subtarget features that turn on this HW mode.
  // For example, &quot;+feat1,-feat2&quot; will indicate that the mode is active
  // when &quot;feat1&quot; is enabled and &quot;feat2&quot; is disabled at the same time.
  // Any other features are not checked.
  // When multiple modes are used, they should be mutually exclusive,
  // otherwise the results are unpredictable.
  string Features = FS;
}

// A special mode recognized by tablegen. This mode is considered active
// when no other mode is active. For targets that do not use specific hw
// modes, this is the only mode.
def DefaultMode : HwMode&lt;&quot;&quot;&gt;;

// A class used to associate objects with HW modes. It is only intended to
// be used as a base class, where the derived class should contain a member
// &quot;Objects&quot;, which is a list of the same length as the list of modes.
// The n-th element on the Objects list will be associated with the n-th
// element on the Modes list.
class HwModeSelect&lt;list&lt;HwMode&gt; Ms&gt; {
  list&lt;HwMode&gt; Modes = Ms;
}

// A common class that implements a counterpart of ValueType, which is
// dependent on a HW mode. This class inherits from ValueType itself,
// which makes it possible to use objects of this class where ValueType
// objects could be used. This is specifically applicable to selection
// patterns.
class ValueTypeByHwMode&lt;list&lt;HwMode&gt; Ms, list&lt;ValueType&gt; Ts&gt;
    : HwModeSelect&lt;Ms&gt;, ValueType&lt;0, 0&gt; {
  // The length of this list must be the same as the length of Ms.
  list&lt;ValueType&gt; Objects = Ts;
}

// A class representing the register size, spill size and spill alignment
// in bits of a register.
class RegInfo&lt;int RS, int SS, int SA&gt; {
  int RegSize = RS;         // Register size in bits.
  int SpillSize = SS;       // Spill slot size in bits.
  int SpillAlignment = SA;  // Spill slot alignment in bits.
}

// The register size/alignment information, parameterized by a HW mode.
class RegInfoByHwMode&lt;list&lt;HwMode&gt; Ms = [], list&lt;RegInfo&gt; Ts = []&gt;
    : HwModeSelect&lt;Ms&gt; {
  // The length of this list must be the same as the length of Ms.
  list&lt;RegInfo&gt; Objects = Ts;
}

// SubRegIndex - Use instances of SubRegIndex to identify subregisters.
class SubRegIndex&lt;int size, int offset = 0&gt; {
  string Namespace = &quot;&quot;;

  // Size - Size (in bits) of the sub-registers represented by this index.
  int Size = size;

  // Offset - Offset of the first bit that is part of this sub-register index.
  // Set it to -1 if the same index is used to represent sub-registers that can
  // be at different offsets (for example when using an index to access an
  // element in a register tuple).
  int Offset = offset;

  // ComposedOf - A list of two SubRegIndex instances, [A, B].
  // This indicates that this SubRegIndex is the result of composing A and B.
  // See ComposedSubRegIndex.
  list&lt;SubRegIndex&gt; ComposedOf = [];

  // CoveringSubRegIndices - A list of two or more sub-register indexes that
  // cover this sub-register.
  //
  // This field should normally be left blank as TableGen can infer it.
  //
  // TableGen automatically detects sub-registers that straddle the registers
  // in the SubRegs field of a Register definition. For example:
  //
  //   Q0    = dsub_0 -&gt; D0, dsub_1 -&gt; D1
  //   Q1    = dsub_0 -&gt; D2, dsub_1 -&gt; D3
  //   D1_D2 = dsub_0 -&gt; D1, dsub_1 -&gt; D2
  //   QQ0   = qsub_0 -&gt; Q0, qsub_1 -&gt; Q1
  //
  // TableGen will infer that D1_D2 is a sub-register of QQ0. It will be given
  // the synthetic index dsub_1_dsub_2 unless some SubRegIndex is defined with
  // CoveringSubRegIndices = [dsub_1, dsub_2].
  list&lt;SubRegIndex&gt; CoveringSubRegIndices = [];
}

// ComposedSubRegIndex - A sub-register that is the result of composing A and B.
// Offset is set to the sum of A and B's Offsets. Size is set to B's Size.
class ComposedSubRegIndex&lt;SubRegIndex A, SubRegIndex B&gt;
  : SubRegIndex&lt;B.Size, !if(!eq(A.Offset, -1), -1,
                        !if(!eq(B.Offset, -1), -1,
                            !add(A.Offset, B.Offset)))&gt; {
  // See SubRegIndex.
  let ComposedOf = [A, B];
}

// RegAltNameIndex - The alternate name set to use for register operands of
// this register class when printing.
class RegAltNameIndex {
  string Namespace = &quot;&quot;;

  // A set to be used if the name for a register is not defined in this set.
  // This allows creating name sets with only a few alternative names.
  RegAltNameIndex FallbackRegAltNameIndex = ?;
}
def NoRegAltName : RegAltNameIndex;

// Register - You should define one instance of this class for each register
// in the target machine.  String n will become the &quot;name&quot; of the register.
class Register&lt;string n, list&lt;string&gt; altNames = []&gt; {
  string Namespace = &quot;&quot;;
  string AsmName = n;
  list&lt;string&gt; AltNames = altNames;

  // Aliases - A list of registers that this register overlaps with.  A read or
  // modification of this register can potentially read or modify the aliased
  // registers.
  list&lt;Register&gt; Aliases = [];

  // SubRegs - A list of registers that are parts of this register. Note these
  // are &quot;immediate&quot; sub-registers and the registers within the list do not
  // themselves overlap. e.g. For X86, EAX's SubRegs list contains only [AX],
  // not [AX, AH, AL].
  list&lt;Register&gt; SubRegs = [];

  // SubRegIndices - For each register in SubRegs, specify the SubRegIndex used
  // to address it. Sub-sub-register indices are automatically inherited from
  // SubRegs.
  list&lt;SubRegIndex&gt; SubRegIndices = [];

  // RegAltNameIndices - The alternate name indices which are valid for this
  // register.
  list&lt;RegAltNameIndex&gt; RegAltNameIndices = [];

  // DwarfNumbers - Numbers used internally by gcc/gdb to identify the register.
  // These values can be determined by locating the &lt;target&gt;.h file in the
  // directory llvmgcc/gcc/config/&lt;target&gt;/ and looking for REGISTER_NAMES.  The
  // order of these names correspond to the enumeration used by gcc.  A value of
  // -1 indicates that the gcc number is undefined and -2 that register number
  // is invalid for this mode/flavour.
  list&lt;int&gt; DwarfNumbers = [];

  // CostPerUse - Additional cost of instructions using this register compared
  // to other registers in its class. The register allocator will try to
  // minimize the number of instructions using a register with a CostPerUse.
  // This is used by the ARC target, by the ARM Thumb and x86-64 targets, where
  // some registers require larger instruction encodings, by the RISC-V target,
  // where some registers preclude using some C instructions.
  int CostPerUse = 0;

  // CoveredBySubRegs - When this bit is set, the value of this register is
  // completely determined by the value of its sub-registers.  For example, the
  // x86 register AX is covered by its sub-registers AL and AH, but EAX is not
  // covered by its sub-register AX.
  bit CoveredBySubRegs = 0;

  // HWEncoding - The target specific hardware encoding for this register.
  bits&lt;16&gt; HWEncoding = 0;

  bit isArtificial = 0;
}

// RegisterWithSubRegs - This can be used to define instances of Register which
// need to specify sub-registers.
// List &quot;subregs&quot; specifies which registers are sub-registers to this one. This
// is used to populate the SubRegs and AliasSet fields of TargetRegisterDesc.
// This allows the code generator to be careful not to put two values with
// overlapping live ranges into registers which alias.
class RegisterWithSubRegs&lt;string n, list&lt;Register&gt; subregs&gt; : Register&lt;n&gt; {
  let SubRegs = subregs;
}

// DAGOperand - An empty base class that unifies RegisterClass's and other forms
// of Operand's that are legal as type qualifiers in DAG patterns.  This should
// only ever be used for defining multiclasses that are polymorphic over both
// RegisterClass's and other Operand's.
class DAGOperand {
  string OperandNamespace = &quot;MCOI&quot;;
  string DecoderMethod = &quot;&quot;;
}

// RegisterClass - Now that all of the registers are defined, and aliases
// between registers are defined, specify which registers belong to which
// register classes.  This also defines the default allocation order of
// registers by register allocators.
//
class RegisterClass&lt;string namespace, list&lt;ValueType&gt; regTypes, int alignment,
                    dag regList, RegAltNameIndex idx = NoRegAltName&gt;
  : DAGOperand {
  string Namespace = namespace;

  // The register size/alignment information, parameterized by a HW mode.
  RegInfoByHwMode RegInfos;

  // RegType - Specify the list ValueType of the registers in this register
  // class.  Note that all registers in a register class must have the same
  // ValueTypes.  This is a list because some targets permit storing different
  // types in same register, for example vector values with 128-bit total size,
  // but different count/size of items, like SSE on x86.
  //
  list&lt;ValueType&gt; RegTypes = regTypes;

  // Size - Specify the spill size in bits of the registers.  A default value of
  // zero lets tablegen pick an appropriate size.
  int Size = 0;

  // Alignment - Specify the alignment required of the registers when they are
  // stored or loaded to memory.
  //
  int Alignment = alignment;

  // CopyCost - This value is used to specify the cost of copying a value
  // between two registers in this register class. The default value is one
  // meaning it takes a single instruction to perform the copying. A negative
  // value means copying is extremely expensive or impossible.
  int CopyCost = 1;

  // MemberList - Specify which registers are in this class.  If the
  // allocation_order_* method are not specified, this also defines the order of
  // allocation used by the register allocator.
  //
  dag MemberList = regList;

  // AltNameIndex - The alternate register name to use when printing operands
  // of this register class. Every register in the register class must have
  // a valid alternate name for the given index.
  RegAltNameIndex altNameIndex = idx;

  // isAllocatable - Specify that the register class can be used for virtual
  // registers and register allocation.  Some register classes are only used to
  // model instruction operand constraints, and should have isAllocatable = 0.
  bit isAllocatable = 1;

  // AltOrders - List of alternative allocation orders. The default order is
  // MemberList itself, and that is good enough for most targets since the
  // register allocators automatically remove reserved registers and move
  // callee-saved registers to the end.
  list&lt;dag&gt; AltOrders = [];

  // AltOrderSelect - The body of a function that selects the allocation order
  // to use in a given machine function. The code will be inserted in a
  // function like this:
  //
  //   static inline unsigned f(const MachineFunction &amp;MF) { ... }
  //
  // The function should return 0 to select the default order defined by
  // MemberList, 1 to select the first AltOrders entry and so on.
  code AltOrderSelect = [{}];

  // Specify allocation priority for register allocators using a greedy
  // heuristic. Classes with higher priority values are assigned first. This is
  // useful as it is sometimes beneficial to assign registers to highly
  // constrained classes first. The value has to be in the range [0,63].
  int AllocationPriority = 0;

  // Generate register pressure set for this register class and any class
  // synthesized from it. Set to 0 to inhibit unneeded pressure sets.
  bit GeneratePressureSet = 1;

  // Weight override for register pressure calculation. This is the value
  // TargetRegisterClass::getRegClassWeight() will return. The weight is in
  // units of pressure for this register class. If unset tablegen will
  // calculate a weight based on a number of register units in this register
  // class registers. The weight is per register.
  int Weight = ?;

  // The diagnostic type to present when referencing this operand in a match
  // failure error message. If this is empty, the default Match_InvalidOperand
  // diagnostic type will be used. If this is &quot;&lt;name&gt;&quot;, a Match_&lt;name&gt; enum
  // value will be generated and used for this operand type. The target
  // assembly parser is responsible for converting this into a user-facing
  // diagnostic message.
  string DiagnosticType = &quot;&quot;;

  // A diagnostic message to emit when an invalid value is provided for this
  // register class when it is being used an an assembly operand. If this is
  // non-empty, an anonymous diagnostic type enum value will be generated, and
  // the assembly matcher will provide a function to map from diagnostic types
  // to message strings.
  string DiagnosticString = &quot;&quot;;
}

// The memberList in a RegisterClass is a dag of set operations. TableGen
// evaluates these set operations and expand them into register lists. These
// are the most common operation, see test/TableGen/SetTheory.td for more
// examples of what is possible:
//
// (add R0, R1, R2) - Set Union. Each argument can be an individual register, a
// register class, or a sub-expression. This is also the way to simply list
// registers.
//
// (sub GPR, SP) - Set difference. Subtract the last arguments from the first.
//
// (and GPR, CSR) - Set intersection. All registers from the first set that are
// also in the second set.
//
// (sequence &quot;R%u&quot;, 0, 15) -&gt; [R0, R1, ..., R15]. Generate a sequence of
// numbered registers.  Takes an optional 4th operand which is a stride to use
// when generating the sequence.
//
// (shl GPR, 4) - Remove the first N elements.
//
// (trunc GPR, 4) - Truncate after the first N elements.
//
// (rotl GPR, 1) - Rotate N places to the left.
//
// (rotr GPR, 1) - Rotate N places to the right.
//
// (decimate GPR, 2) - Pick every N'th element, starting with the first.
//
// (interleave A, B, ...) - Interleave the elements from each argument list.
//
// All of these operators work on ordered sets, not lists. That means
// duplicates are removed from sub-expressions.

// Set operators. The rest is defined in TargetSelectionDAG.td.
def sequence;
def decimate;
def interleave;

// RegisterTuples - Automatically generate super-registers by forming tuples of
// sub-registers. This is useful for modeling register sequence constraints
// with pseudo-registers that are larger than the architectural registers.
//
// The sub-register lists are zipped together:
//
//   def EvenOdd : RegisterTuples&lt;[sube, subo], [(add R0, R2), (add R1, R3)]&gt;;
//
// Generates the same registers as:
//
//   let SubRegIndices = [sube, subo] in {
//     def R0_R1 : RegisterWithSubRegs&lt;&quot;&quot;, [R0, R1]&gt;;
//     def R2_R3 : RegisterWithSubRegs&lt;&quot;&quot;, [R2, R3]&gt;;
//   }
//
// The generated pseudo-registers inherit super-classes and fields from their
// first sub-register. Most fields from the Register class are inferred, and
// the AsmName and Dwarf numbers are cleared.
//
// RegisterTuples instances can be used in other set operations to form
// register classes and so on. This is the only way of using the generated
// registers.
//
// RegNames may be specified to supply asm names for the generated tuples.
// If used must have the same size as the list of produced registers.
class RegisterTuples&lt;list&lt;SubRegIndex&gt; Indices, list&lt;dag&gt; Regs,
                     list&lt;string&gt; RegNames = []&gt; {
  // SubRegs - N lists of registers to be zipped up. Super-registers are
  // synthesized from the first element of each SubRegs list, the second
  // element and so on.
  list&lt;dag&gt; SubRegs = Regs;

  // SubRegIndices - N SubRegIndex instances. This provides the names of the
  // sub-registers in the synthesized super-registers.
  list&lt;SubRegIndex&gt; SubRegIndices = Indices;

  // List of asm names for the generated tuple registers.
  list&lt;string&gt; RegAsmNames = RegNames;
}


//===----------------------------------------------------------------------===//
// DwarfRegNum - This class provides a mapping of the llvm register enumeration
// to the register numbering used by gcc and gdb.  These values are used by a
// debug information writer to describe where values may be located during
// execution.
class DwarfRegNum&lt;list&lt;int&gt; Numbers&gt; {
  // DwarfNumbers - Numbers used internally by gcc/gdb to identify the register.
  // These values can be determined by locating the &lt;target&gt;.h file in the
  // directory llvmgcc/gcc/config/&lt;target&gt;/ and looking for REGISTER_NAMES.  The
  // order of these names correspond to the enumeration used by gcc.  A value of
  // -1 indicates that the gcc number is undefined and -2 that register number
  // is invalid for this mode/flavour.
  list&lt;int&gt; DwarfNumbers = Numbers;
}

// DwarfRegAlias - This class declares that a given register uses the same dwarf
// numbers as another one. This is useful for making it clear that the two
// registers do have the same number. It also lets us build a mapping
// from dwarf register number to llvm register.
class DwarfRegAlias&lt;Register reg&gt; {
      Register DwarfAlias = reg;
}
</code></pre>
<hr />
<h2 id="csky">CSKY</h2>
<h4 id="define-the-cskyreg">define the <code>CSKYReg</code></h4>
<pre><code class="language-c++">let Namespace = &quot;CSKY&quot; in {
  class CSKYReg&lt;bits&lt;6&gt; Enc, string n, list&lt;string&gt; alt = []&gt; : Register&lt;n&gt; {
    let HWEncoding{5 - 0} = Enc;
    let AltNames = alt;
  }
  def ABIRegAltName : RegAltNameIndex;
} // Namespace = &quot;CSKY&quot; 
</code></pre>
<p><code>ABIRegAltName</code>用于在汇编中显示，一般是没有这个的, AltNames是别名</p>
<h3 id="use-the-cskyreg">Use the <code>CSKYReg</code></h3>
<p><code>[a0]</code>等用于在汇编中进行显示，一般是没有这个的。</p>
<pre><code class="language-c++">let RegAltNameIndices = [ABIRegAltName] in {
  def R0 : CSKYReg&lt;0, &quot;r0&quot;, [&quot;a0&quot;]&gt;, DwarfRegNum&lt;[0]&gt;;
  def R1 : CSKYReg&lt;1, &quot;r1&quot;, [&quot;a1&quot;]&gt;, DwarfRegNum&lt;[1]&gt;;
  def R2 : CSKYReg&lt;2, &quot;r2&quot;, [&quot;a2&quot;]&gt;, DwarfRegNum&lt;[2]&gt;;
  def R3 : CSKYReg&lt;3, &quot;r3&quot;, [&quot;a3&quot;]&gt;, DwarfRegNum&lt;[3]&gt;;
  def R4 : CSKYReg&lt;4, &quot;r4&quot;, [&quot;l0&quot;]&gt;, DwarfRegNum&lt;[4]&gt;;
  def R5 : CSKYReg&lt;5, &quot;r5&quot;, [&quot;l1&quot;]&gt;, DwarfRegNum&lt;[5]&gt;;
  def R6 : CSKYReg&lt;6, &quot;r6&quot;, [&quot;l2&quot;]&gt;, DwarfRegNum&lt;[6]&gt;;
  def R7 : CSKYReg&lt;7, &quot;r7&quot;, [&quot;l3&quot;]&gt;, DwarfRegNum&lt;[7]&gt;;
  def R8 : CSKYReg&lt;8, &quot;r8&quot;, [&quot;l4&quot;]&gt;, DwarfRegNum&lt;[8]&gt;;
  def R9 : CSKYReg&lt;9, &quot;r9&quot;, [&quot;l5&quot;]&gt;, DwarfRegNum&lt;[9]&gt;;
  def R10 : CSKYReg&lt;10, &quot;r10&quot;, [&quot;l6&quot;]&gt;, DwarfRegNum&lt;[10]&gt;;
  def R11 : CSKYReg&lt;11, &quot;r11&quot;, [&quot;l7&quot;]&gt;, DwarfRegNum&lt;[11]&gt;;
  def R12 : CSKYReg&lt;12, &quot;r12&quot;, [&quot;t0&quot;]&gt;, DwarfRegNum&lt;[12]&gt;;
  def R13 : CSKYReg&lt;13, &quot;r13&quot;, [&quot;t1&quot;]&gt;, DwarfRegNum&lt;[13]&gt;;
  def R14 : CSKYReg&lt;14, &quot;r14&quot;, [&quot;sp&quot;]&gt;, DwarfRegNum&lt;[14]&gt;;
  def R15 : CSKYReg&lt;15, &quot;r15&quot;, [&quot;lr&quot;]&gt;, DwarfRegNum&lt;[15]&gt;;
  def R16 : CSKYReg&lt;16, &quot;r16&quot;, [&quot;l8&quot;]&gt;, DwarfRegNum&lt;[16]&gt;;
  def R17 : CSKYReg&lt;17, &quot;r17&quot;, [&quot;l9&quot;]&gt;, DwarfRegNum&lt;[17]&gt;;
  def R18 : CSKYReg&lt;18, &quot;r18&quot;, [&quot;t2&quot;]&gt;, DwarfRegNum&lt;[18]&gt;;
  def R19 : CSKYReg&lt;19, &quot;r19&quot;, [&quot;t3&quot;]&gt;, DwarfRegNum&lt;[19]&gt;;
  def R20 : CSKYReg&lt;20, &quot;r20&quot;, [&quot;t4&quot;]&gt;, DwarfRegNum&lt;[20]&gt;;
  def R21 : CSKYReg&lt;21, &quot;r21&quot;, [&quot;t5&quot;]&gt;, DwarfRegNum&lt;[21]&gt;;
  def R22 : CSKYReg&lt;22, &quot;r22&quot;, [&quot;t6&quot;]&gt;, DwarfRegNum&lt;[22]&gt;;
  def R23 : CSKYReg&lt;23, &quot;r23&quot;, [&quot;t7&quot;]&gt;, DwarfRegNum&lt;[23]&gt;;
  def R24 : CSKYReg&lt;24, &quot;r24&quot;, [&quot;t8&quot;]&gt;, DwarfRegNum&lt;[24]&gt;;
  def R25 : CSKYReg&lt;25, &quot;r25&quot;, [&quot;t9&quot;]&gt;, DwarfRegNum&lt;[25]&gt;;
  def R26 : CSKYReg&lt;26, &quot;r26&quot;, [&quot;r26&quot;]&gt;, DwarfRegNum&lt;[26]&gt;;
  def R27 : CSKYReg&lt;27, &quot;r27&quot;, [&quot;r27&quot;]&gt;, DwarfRegNum&lt;[27]&gt;;
  def R28 : CSKYReg&lt;28, &quot;r28&quot;, [&quot;rgb&quot;]&gt;, DwarfRegNum&lt;[28]&gt;;
  def R29 : CSKYReg&lt;29, &quot;r29&quot;, [&quot;rtb&quot;]&gt;, DwarfRegNum&lt;[29]&gt;;
  def R30 : CSKYReg&lt;30, &quot;r30&quot;, [&quot;svbr&quot;]&gt;, DwarfRegNum&lt;[30]&gt;;
  def R31 : CSKYReg&lt;31, &quot;r31&quot;, [&quot;tls&quot;]&gt;, DwarfRegNum&lt;[31]&gt;;
  def CR0 : CSKYReg&lt;33, &quot;cr0&quot;, [&quot;psr&quot;]&gt;;
  def HI : CSKYReg&lt;34, &quot;hi&quot;, [&quot;hi&quot;]&gt;, DwarfRegNum&lt;[36]&gt;;
  def LO : CSKYReg&lt;35, &quot;lo&quot;, [&quot;lo&quot;]&gt;, DwarfRegNum&lt;[37]&gt;;

  let Aliases = [R14] in def SP : CSKYReg&lt;14, &quot;r14&quot;, [&quot;sp&quot;]&gt;, DwarfRegNum&lt;[14]&gt;;
  let Aliases = [R15] in def LR : CSKYReg&lt;15, &quot;r15&quot;, [&quot;lr&quot;]&gt;, DwarfRegNum&lt;[15]&gt;;
  let Aliases = [R28] in def GP : CSKYReg&lt;28, &quot;r28&quot;, [&quot;rgb&quot;]&gt;,
      DwarfRegNum&lt;[28]&gt;;
}
</code></pre>
<p>定义<code>GPR</code></p>
<pre><code class="language-c++">def GPR : RegisterClass&lt;&quot;CSKY&quot;, [i32], 32,
                        (add(sequence &quot;R%u&quot;, 0, 3), (sequence &quot;R%u&quot;, 12, 13),
                         (sequence &quot;R%u&quot;, 18, 25), LR, (sequence &quot;R%u&quot;, 4, 11),
                         (sequence &quot;R%u&quot;, 16, 17), (sequence &quot;R%u&quot;, 26, 27), GP,
                         (sequence &quot;R%u&quot;, 29, 30), SP, R31)&gt; {
  let Size = 32;
}
</code></pre>
<p><code>(sequence "R%u", 18, 25)</code>表示<code>R18, R19 ... R25</code></p>
<p>可以在<code>CSKYGenRegisterInfo.inc</code>中看到GPR的定义</p>
<pre><code>// GPR MCPhysReg GPR[] = {
  CSKY::RO, CSKY::R1, CSKY::R2, CSKY::R3, CSKY::R12....
}
</code></pre>
<p>这里的顺序也是分配<code>GPR</code>寄存器时的顺序。</p>
<pre><code class="language-c++">def AL : Register&lt;&quot;AL&quot;&gt;, DwarfRegNum&lt;[0, 0, 0]&gt;;
定义了寄存器AL并给它赋值（用DwarfRegNum）以用于gcc、gdb或者一个调试信息输入来标识一个寄存器。对于寄存器AL，DwarfRegNum携带三个值的数组表示三种不同的模式：第一个元素用来表示X86-64，第二个用来在X86-32上的异常处理（EH），第三个是一般用途。-1是个表示gcc数字没有定义，-2表示该模式下寄存器号无效。 

// DwarfRegNum是用在gcc/gdb中的


def D0 : Rd&lt; 0, &quot;F0&quot;, [F0, F1]&gt;, DwarfRegNum&lt;[32]&gt;;
def D1 : Rd&lt; 2, &quot;F2&quot;, [F2, F3]&gt;, DwarfRegNum&lt;[34]&gt;;
上面所示的最后两个寄存器（D0和D1）都是双精度浮点寄存器作为一双单精度浮点数子寄存器的别名。其他的别名，已经定义的寄存器的子寄存器与父寄存器的关系都在寄存器的TargetRegisterDesc的字段中。
</code></pre>
<hr />
<h2 id="registerinfocpp">RegisterInfo.cpp</h2>
<h4 id="1-csr-register">1 CSR register</h4>
<h4 id="getcalleesavedregs"><code>getCalleeSavedRegs</code></h4>
<pre><code class="language-c++">const MCPhysReg *
CSKYRegisterInfo::getCalleeSavedRegs(const MachineFunction *MF) const {
  const CSKYSubtarget &amp;STI = MF-&gt;getSubtarget&lt;CSKYSubtarget&gt;();
  if (STI.hasFPUv2DoubleFloat() || STI.hasFPUv3DoubleFloat())
    return CSR_GPR_FPR64_SaveList;
  if (STI.hasFPUv2SingleFloat() || STI.hasFPUv3SingleFloat())
    return CSR_GPR_FPR32_SaveList;
  return CSR_I32_SaveList;
}
</code></pre>
<p>在<code>CallingConv.td</code>中能看到</p>
<pre><code>def CSR_I32: CallingSavedRegs&lt;add LR, GP, (sequence &quot;R%u, 4, 11&quot;),
                               (sequence &quot;R%u, 16, 17&quot;)&gt;
</code></pre>
<p><code>GenRegisterInfo.inc</code>中能看到</p>
<pre><code>static const CSR_I32_SaveList[] = {CSKY::LR, CSKY::GP .. CSKY::R17}
</code></pre>
<h3 id="2-getreservedregs">2. getReservedRegs</h3>
<pre><code class="language-c++">BitVector CSKYRegisterInfo::getReservedRegs(const MachineFunction &amp;MF) const {
  BitVector Reserved(getNumRegs());
  markSuperRegs(Reserved, CSKY::SP);
  markSuperRegs(Reserved, CSKY::R26);
  markSuperRegs(Reserved, CSKY::R27);
  markSuperRegs(Reserved, CSKY::GP);
  markSuperRegs(Reserved, CSKY::R29);
  markSuperRegs(Reserved, CSKY::R30);
  markSuperRegs(Reserved, CSKY::R31);
  // TODO: FP, BP
  assert(checkAllSuperRegsMarked(Reserved));
  return Reserved;
}
</code></pre>
<h3 id="3-eliminatecallframepseudoinstr">3.  eliminateCallFramePseudoInstr</h3>
<p>LLVM 中间表示采用 ADJCALLSTACKDOWN 或 ADJCALLSTACKUP 虚拟指令描述堆栈指针的变化，而在最后生成汇编时，需用 C<em>Core 真实指令代替，即利用 C</em>Core的 ADDI 指令实现堆栈指针的调整。</p>
<pre><code class="language-c++">MachineBasicBlock::iterator CSKYFrameLowering::eliminateCallFramePseudoInstr(
    MachineFunction &amp;MF, MachineBasicBlock &amp;MBB,
    MachineBasicBlock::iterator MI) const {
  const CSKYInstrInfo *TII = STI.getInstrInfo();
  DebugLoc DL = MI-&gt;getDebugLoc();

  if (!hasReservedCallFrame(MF)) {
    int64_t Amount = MI-&gt;getOperand(0).getImm();
    if (MI-&gt;getOpcode() == CSKY::ADJCALLSTACKDOWN)
      Amount = -Amount;

    // Adjust sp register
    emitSPAdj(MBB, MI, DL, TII, Amount);
  }
  return MBB.erase(MI);
}
</code></pre>
<h3 id="4-eliminateframeindex">4. eliminateFrameIndex</h3>
<p><code>CSKYRegisterInfo.cpp</code></p>
<p>LLVM 中间表示利用虚拟栈帧索引管理函数调用时的栈空间。C*Core 则根据调用的函数是否调整堆栈空间或调用其它函数，决定了当前虚拟栈帧索引存放在堆栈指针寄存器 R0，抑或临时栈帧寄存器 R8。</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../../js/base.js"></script>
        <script src="../../../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
