<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../img/favicon.ico">
        <title>Glue & chain side effect - My Docs</title>
        <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../cast/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../liveness/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            
            
            
            
            
            
            <li class="nav-item" data-bs-level="1"><a href="#sdnode-must-has-result" class="nav-link">SDNode must has result</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h3 id="note-side-effects">NOTE: Side Effects</h3>
<p>这里提到的side effects不是td文件中描述机器指令的hasSideEffects中的。td文件中的hasSideEffects是机器指令属性，他可以在ABI中查找，每个指令后面的有<code>Special Registers Altered</code>表明某条指令是否有side effects。那些<code>Special Registers Altered</code>是空的指令,如<code>VEXTRACTUB</code>的hasSideEffects应该为false。</p>
<p>这时所说的side effects是ISD的指令上的，不是机器指令的。必须注意。</p>
<p>cat <code>include/llvm/CodeGen/ISDOpcodes.h</code></p>
<pre><code class="language-shell">   /// RESULT = INTRINSIC_WO_CHAIN(INTRINSICID, arg1, arg2, ...)
 146     /// This node represents a target intrinsic function with no side effects.
 147     /// The first operand is the ID number of the intrinsic from the
 148     /// llvm::Intrinsic namespace.  The operands to the intrinsic follow.  The
 149     /// node returns the result of the intrinsic.
 150     INTRINSIC_WO_CHAIN,
 151   LowerINTRINSIC_WO_CHAIN
 152     /// RESULT,OUTCHAIN = INTRINSIC_W_CHAIN(INCHAIN, INTRINSICID, arg1, ...)
 153     /// This node represents a target intrinsic function with side effects that
 154     /// returns a result.  The first operand is a chain pointer.  The second is
 155     /// the ID number of the intrinsic from the llvm::Intrinsic namespace.  The
 156     /// operands to the intrinsic follow.  The node has two results, the result
 157     /// of the intrinsic and an output chain.
 158     INTRINSIC_W_CHAIN,
 159  LowerINTRINSIC_W_CHAIN
 160     /// OUTCHAIN = INTRINSIC_VOID(INCHAIN, INTRINSICID, arg1, arg2, ...)
 161     /// This node represents a target intrinsic function with side effects that
 162     /// does not return a result.  The first operand is a chain pointer.  The
 163     /// second is the ID number of the intrinsic from the llvm::Intrinsic
 164     /// namespace.  The operands to the intrinsic follow.
 165     INTRINSIC_VOID,
 166  LowerINTRINSIC_VOID
</code></pre>
<p>这里<code>INTRINSIC_WO_CHAIN</code>没有副作用，只有一个返回结果</p>
<p><code>INTRINSIC_W_CHAIN</code>有副作用，有两个返回结果，第二个<code>chain</code>表示的就是副作用。</p>
<p><code>INTRINSI_VOID</code>有副作用，返回<code>chian</code>表示副作用。 </p>
<p>https://stackoverflow.com/questions/33005061/what-are-glue-and-chain-dependencies-in-an-llvm-dag</p>
<p>https://people.cs.nctu.edu.tw/~chenwj/dokuwiki/doku.php?id=llvm</p>
<p>http://lists.llvm.org/pipermail/llvm-dev/2014-June/074046.html</p>
<p>SDNode 之間有 data 或 control (chain, 簡寫 ch) dependency。上圖中黑色箭頭代表 data dependency，藍色箭頭代表 control dependency (注意它指向節點中的 ch 欄位)，紅色箭頭代表兩個節點之間是 glue 的關係 (和 ch 相比，glue 之間不能插入其它節點)。EntryToken 和 TokenFactor 負責 control dependency。GraphRoot 代表 SelectionDAG 的最底層。</p>
<p>一個 DAG 基本對應一個 BasicBlock，DAG 中的每一個節點 (SDNode) 基本對應一條 LLVM IR。TargetSelectionDAG.td 定義了 LLVM IR 對應的 SDNode。SDNode 之間是 producer-consumer 的關係，producer 產生 SDValue 給 consumer。SDValue 有底下三種型別:</p>
<pre><code>        concrete value type: 對映黑色實線。
        Other: 對映藍色虛線ch。
        Glue: 對映紅色實線。
</code></pre>
<h3 id="side-effectglue-chainside-effects">Side Effect(glue &amp; chain都是用来处理side effects)的</h3>
<p>如果输出只取决于输入，则为no side effect.
使用隐匿REG或内存等则有side effect.</p>
<h3 id="dependencies-as-edges">Dependencies as edges</h3>
<ul>
<li>Data</li>
<li>Order (“chain”)</li>
<li>Scheduling (“glue”)</li>
</ul>
<h3 id="chainreg">Chain调度时防止有负作用的结果乱序（修改、使用隐含reg等）</h3>
<p>如使用隐式reg,如果是使用显示的寄存器，llvm知道他们之间会有读写关系。</p>
<p><code>Chain</code> dependencies prevent nodes with side effects (including <code>memory operations</code> and <code>explicit register operations</code>) from being scheduled out of order relative to each other.
- <code>memory operations</code> 
- <code>explicit register operations</code> </p>
<p>ch is the last Node in result, and it's the first Node in the input Operand.</p>
<pre><code>Legalizing: t7: f64,ch = PPCISD::MFFS t0
Legal node: nothing to do
Legalized selection DAG: %bb.0 'test_setrnd_imm1:entry'
SelectionDAG has 9 nodes:
      t9: ch = PPCISD::MTFSB0 t7:1, Constant:i32&lt;31&gt;
    t11: ch = PPCISD::MTFSB1 t9, Constant:i32&lt;30&gt;
  t5: ch,glue = CopyToReg t11, Register:f64 $f1, t7
    t0: ch = EntryToken
  t7: f64,ch = PPCISD::MFFS t0
  t6: ch = PPCISD::RET_FLAG t5, Register:f64 $f1, t5:1
</code></pre>
<p>Here <code>t5 == t5:0 == ch</code>, <code>t5:1 == glue</code>
对于任何Node, <code>t:0 == t</code>
PPCISD::CALL is chained node</p>
<pre><code>lib/Target/PowerPC/PPCInstrInfo.td


26781 /* 64292*/  /*SwitchOpcode*/ 85, TARGET_VAL(PPCISD::CALL),// -&gt;64380
26782 /* 64295*/    OPC_RecordNode, // #0 = 'PPCcall' chained node
26783 /* 64296*/    OPC_CaptureGlueInput,
26784 /* 64297*/    OPC_RecordChild1, // #1 = $func
26785 /* 64298*/    OPC_MoveChild1,
26786 /* 64299*/    OPC_SwitchOpcode /*3 cases */, 26, TARGET_VAL(ISD::Constant),// -&gt;64329
26787 /* 64303*/      OPC_SwitchType /*2 cases */, 10, MVT::i32,// -&gt;64316
26788 /* 64306*/        OPC_MoveParent,
26789 /* 64307*/        OPC_EmitMergeInputChains1_0,
26790 /* 64308*/        OPC_EmitConvertToTarget, 1,
</code></pre>
<p>访问内存并且或使用特定隐式寄存器的指令需要输入Chain，并返回Chain。</p>
<h3 id="glue">Glue</h3>
<p>Glue bind the two nodes together.
<code>Glue</code> prevents the two nodes from being broken up during scheduling. It's actually more subtle than that [1], but most of the time you don't need to worry about it. (If you're implementing your own backend that requires two instructions to be adjacent to each other, you really want to be using a pseudoinstruction instead, and expand that after scheduling happens.)</p>
<pre><code>Black arrows mean data flow dependency
Red arrows mean glue dependency
Blue dashed arrows mean chain dependency
</code></pre>
<h3 id="ir-property">IR Property</h3>
<ul>
<li>input a chain, output a chain.</li>
<li>glue is created as the result.</li>
</ul>
<pre><code>=== test6
Creating constant: t1: i64 = TargetConstant&lt;5089&gt;
Creating new node: t2: i64,ch = llvm.ppc.get.texasr t0, TargetConstant:i64&lt;5089&gt;
Creating new node: t4: ch,glue = CopyToReg t2:1, Register:i64 $x3, t2
Creating new node: t5: ch = PPCISD::RET_FLAG t4, Register:i64 $x3, t4:1
Initial selection DAG: %bb.0 'test6:entry'
SelectionDAG has 6 nodes:
    t0: ch = EntryToken
  t2: i64,ch = llvm.ppc.get.texasr t0, TargetConstant:i64&lt;5089&gt;
  t4: ch,glue = CopyToReg t2:1, Register:i64 $x3, t2
  t5: ch = PPCISD::RET_FLAG t4, Register:i64 $x3, t4:1
</code></pre>
<p>For below case:</p>
<pre><code> 208 SelectionDAG has 9 nodes:
 209         t0: ch = EntryToken
 210       t9: ch,glue = PPCISD::MTFSB0 t0, Constant:i32&lt;31&gt;
 211     t11: ch,glue = PPCISD::MTFSB1 t9, Constant:i32&lt;30&gt;
 212   t5: ch,glue = CopyToReg t11, Register:f64 $f1, PPCISD::MFFS:f64,glue
 213   t6: ch = PPCISD::RET_FLAG t5, Register:f64 $f1, t5:1
</code></pre>
<p><code>213</code>: <code>t5:1</code> is the <code>glue</code>, <code>t5:0</code> is the <code>ch</code>. <code>t5:0</code> is equal <code>t5</code>, so 
below code is equal</p>
<pre><code> 211     t11: ch,glue = PPCISD::MTFSB1 t9, Constant:i32&lt;30&gt;
 211     t11: ch,glue = PPCISD::MTFSB1 t9:0, Constant:i32&lt;30&gt;
</code></pre>
<p>The in glue operand <code>SDNPOptInGlue</code> must be in the last, and the in glue operand must be in the first.</p>
<h1 id="sdnode-must-has-result">SDNode must has result</h1>
<p>/home/shkzhang/llvm/llvm/utils/TableGen/DAGISelMatcherGen.cpp
SDNode必须有结果，或者是Operand，或者是Glue或Chain.</p>
<pre><code>907   assert((!ResultVTs.empty() || TreeHasOutGlue || NodeHasChain) &amp;&amp;
908          &quot;Node has no result&quot;);
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../js/base.js"></script>
        <script src="../../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
