<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../img/favicon.ico">
        <title>setOperationAction - My Docs</title>
        <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../pattern%20pat/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../Intrinsic/Intrinsic/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#1-isd" class="nav-link">1. 框架中的ISD结点</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#2" class="nav-link">2 为架构添加原始支持的类型</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p>https://blog.csdn.net/jinweifu/article/details/54132939</p>
<p>https://zhuanlan.zhihu.com/p/69406037(Important)</p>
<h1 id="1-isd">1. 框架中的ISD结点</h1>
<p>非框架中的自定义的结果，不存在下面说的4种情况，只有一种情况，不需要调用<code>setOperationAction()</code></p>
<h3 id="11-legal">1.1 Legal</h3>
<p>Legal代表默认的情况，所以它很少被使用。默认的ISD都认为是Legal，直接进入到指令选择，没有合适的就报错。</p>
<p>If the new ISD instrucion, you can find one machine instruction for it, you can set it legal, and then, you modify the select() function to select it, or you use the td file to call SelectCode() function. </p>
<pre><code class="language-c++">setOperationAction(ISD::ADD, VT, Legal); 
</code></pre>
<h3 id="12-customexpandbasecustom">1.2 Custom(Expand觉得Base提供的方法，不好的时候，用Custom)</h3>
<p>Or you can't find a machine instruction for it, but you want the compiler create this ISD instruction, you should set it to CUSTOM, and then you should legalize this instruction in the Lowering. 必须有相应的Lowering方法。</p>
<pre><code class="language-c++">setOperationAction(ISD::SETCC, MVT::i32, Custom);
</code></pre>
<h5 id="ppciselloweringcpp">PPCISelLowering.cpp</h5>
<pre><code class="language-c++">SDValue PPCTargetLowering::LowerOperation(SDValue Op, SelectionDAG &amp;DAG) const {
  switch (Op.getOpcode()) {
  default: llvm_unreachable(&quot;Wasn't expecting to be able to lower this!&quot;);
  case ISD::ConstantPool:       return LowerConstantPool(Op, DAG);
  case ISD::BlockAddress:       return LowerBlockAddress(Op, DAG);
  case ISD::GlobalAddress:      return LowerGlobalAddress(Op, DAG);
  case ISD::GlobalTLSAddress:   return LowerGlobalTLSAddress(Op, DAG);
  case ISD::JumpTable:          return LowerJumpTable(Op, DAG);
  case ISD::SETCC:              return LowerSETCC(Op, DAG);
  case ISD::INIT_TRAMPOLINE:    return LowerINIT_TRAMPOLINE(Op, DAG);
  case ISD::ADJUST_TRAMPOLINE:  return LowerADJUST_TRAMPOLINE(Op, DAG);
  ...
}
</code></pre>
<h3 id="13-expand">1.3 Expand</h3>
<p>You machine instruction can't support this ISD instruction, and you don't want to support this ISD instruction, you can set it Expand, so this ISD instruction will not be created.</p>
<p>对于本地不支持的类型，一个值可能需要被打散。对于一个本地不支持的操作操作，其他操作的合并可能被用来达到相似的效果。在SPARC中，浮点Sine和cosine三角操作通过扩展其他操作来支持，在第三个参数中指定为Expand给<code>setOperationAction</code>，<code>Expand</code>可能由基类提供的<code>ExpandINSERT_VECTOR_ELT（）</code>方法完成，也可能由Target Hook自定义的方法完成。通过其它合法的操作序列或库函数模拟该操作。</p>
<pre><code class="language-c++">

setOperationAction(ISD::INSERT_VECTOR_ELT, VT, Expand);   // 使用Base提供的Expand
setOperationAction(ISD::CTLZ, MVT::i16, Expand),          // 使用Target hook
</code></pre>
<p><code>Expand</code>意味着<code>SelectionDAGLegalize::LegalizeOp()</code>方法将调用的<code>ExpandNode()</code>方法：</p>
<pre><code class="language-c++">/// Return a legal replacement for the given operation, with all legal operands.
void SelectionDAGLegalize::LegalizeOp(SDNode *Node) {
...
    case TargetLowering::Expand:
      if (ExpandNode(Node))
        return;
      LLVM_FALLTHROUGH;
    case TargetLowering::LibCall:
      ConvertNodeToLibcall(Node);
      return;
    case TargetLowering::Promote:
      PromoteNode(Node);
      return;
    }
...    
}
</code></pre>
<pre><code class="language-c++">bool SelectionDAGLegalize::ExpandNode(SDNode *Node) {
  LLVM_DEBUG(dbgs() &lt;&lt; &quot;Trying to expand node\n&quot;);
   ...
 case ISD::CTLZ:
  case ISD::CTLZ_ZERO_UNDEF:
    if (TLI.expandCTLZ(Node, Tmp1, DAG))
      Results.push_back(Tmp1);
    break;
  case ISD::CTTZ:
  case ISD::CTTZ_ZERO_UNDEF:
    if (TLI.expandCTTZ(Node, Tmp1, DAG))
      Results.push_back(Tmp1);
    break;

  case ISD::INSERT_VECTOR_ELT:
    Results.push_back(ExpandINSERT_VECTOR_ELT(Node-&gt;getOperand(0),
                                              Node-&gt;getOperand(1),
                                              Node-&gt;getOperand(2), dl));
    break;
   ...  
 }
</code></pre>
<h3 id="14-promote">1.4 Promote</h3>
<p>For an operation without native support for a given type, the specified type may be promoted to a larger type that is supported. </p>
<p>对于给定一个类型本地并不支持的操作，特定的类型可能要被提升为较大的类型以支持。例如对于Boolean值（i1类型）SPARC不支持符号扩展的load，如此在SparcISelLowering.cpp中第三个参数Promote，在load之前改变i1类型的值为一个较大的值。</p>
<p>提供的具体操作由基类完成。</p>
<pre><code class="language-c++">  497
  498   if (Subtarget.is64BitELFABI()) {
  499     // VAARG always uses double-word chunks, so promote anything smaller.
  500     setOperationAction(ISD::VAARG, MVT::i1, Promote);
  501     AddPromotedToType(ISD::VAARG, MVT::i1, MVT::i64);
  502     setOperationAction(ISD::VAARG, MVT::i8, Promote);
  503     AddPromotedToType(ISD::VAARG, MVT::i8, MVT::i64);
  504     setOperationAction(ISD::VAARG, MVT::i16, Promote);
  505     AddPromotedToType(ISD::VAARG, MVT::i16, MVT::i64);
  506     setOperationAction(ISD::VAARG, MVT::i32, Promote);
  507     AddPromotedToType(ISD::VAARG, MVT::i32, MVT::i64);
  508     setOperationAction(ISD::VAARG, MVT::Other, Expand);
  509   }
</code></pre>
<hr />
<h1 id="2">2 为架构添加原始支持的类型</h1>
<p>使用<code>addRegisterClass</code>来添加支持的类型，不支持的类型可以使用<code>setOperationAction(promote)</code>。</p>
<p>In the constructor for the <code>XXXTargetLowering</code> class, first use the<code>addRegisterClass</code> method to specify which types are supported and which register classes are associated with them.  The code for the register classes are generated by TableGen from <code>XXXRegisterInfo.td</code> and placed in<code>XXXGenRegisterInfo.h.inc</code>.  For example, the implementation of the constructor for the SparcTargetLowering class (in <code>SparcISelLowering.cpp</code>) starts with the following code</p>
<p>以下代码来自于<code>RISCV</code></p>
<pre><code class="language-c++">RISCVTargetLowering::RISCVTargetLowering(const TargetMachine &amp;TM,
                                         const RISCVSubtarget &amp;STI)
    : TargetLowering(TM), Subtarget(STI) {
  ...      
  MVT XLenVT = Subtarget.getXLenVT();

  // Set up the register classes.
  addRegisterClass(XLenVT, &amp;RISCV::GPRRegClass);

  if (Subtarget.hasStdExtF())
    addRegisterClass(MVT::f32, &amp;RISCV::FPR32RegClass);
  if (Subtarget.hasStdExtD())
    addRegisterClass(MVT::f64, &amp;RISCV::FPR64RegClass)
  ...
}
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../js/base.js"></script>
        <script src="../../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
