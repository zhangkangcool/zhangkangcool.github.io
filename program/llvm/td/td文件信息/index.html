<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../img/favicon.ico">
        <title>Td文件信息 - My Docs</title>
        <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../td%20pattern/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../td%E8%AF%AD%E6%B3%95/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="2"><a href="#_1" class="nav-link"></a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#_2" class="nav-link">定义指令</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#sdnode" class="nav-link">. 定义SDNode</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#3-patfrags" class="nav-link">3. PatFrags</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#1-immleaf" class="nav-link">.1 ImmLeaf</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#4-complexpattern" class="nav-link">4 ComplexPattern</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#5" class="nav-link">5. 谓词条件</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#_3" class="nav-link">模式匹配</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="_1"></h2>
<p>https://blog.csdn.net/fs3296/article/details/141831812</p>
<h1 id="_2">定义指令</h1>
<p>td通过class Instruction来定义指令，其各个字段意义如下：</p>
<pre><code class="language-c++">OutOperandList：输出dag节点列表；
InOperandList：输入操作数节点列表；
AsmString：用于在“.s”文件中的汇编显示；
Pattern：用于指令选择匹配的dag列表；
Predicates：用于在指令选择阶段是否启用的条件判断；
Uses：指令引用的寄存器列表；
Defs：指令改写的寄存器列表；
Size：指令编码成二进制的长度，为0表示可变长度；
CodeSize：
Itinerary：按步骤方式的调度模式；
SchedRW：按资源使用的调度模式；
Constraints：约束条件，例如有些指令源寄存器与目的寄存器笔下相同，则$src = $dst;
TSFlags：
</code></pre>
<p>注：还有一个隐含的字段field bits Inst，该字段表示指令转换为二进制时bit位。例如RISCV里面为field bits&lt;32&gt; Inst。</p>
<h1 id="sdnode">. 定义SDNode</h1>
<p>SDNode用于定义一个dag节点，它分别有如下重要参数：</p>
<pre><code class="language-c++">opcode：SDNode的节点枚举；
typeprof：用于描述节点特性的SDTypeProfile类型；
props：节点属性列表，定义在SDNodeProperties.td文件中，对应源码enum SDNP。例如满足交换律、满足结合律、有边界影响；
sdclass：节点对应C++类型名称；
</code></pre>
<p>SDTypeProfile用于描述节点的特性，各个参数如下：</p>
<pre><code class="language-c++">numresults：节点输出值数量；
numoperands：节点输入操作数数量；
constraints：节点输出/入的约束；
</code></pre>
<p>注：SDTypeConstraint用于描述节点的输入输出约束。例如SDTCisInt&lt;2&gt;表示第0个输出/入为int，假设节点numresults为1，numoperands为2，序号从0到2，前面一个为输出、后面两个为输入。</p>
<h1 id="3-patfrags">3. PatFrags</h1>
<p>例如store节点包括unindexed store、normal store、trunc store等，怎么分别定义这些SDNode呢？这时PatFrags就派上用场，其主要的参数如下：</p>
<pre><code class="language-c++">ops与frags：它表示将frags中的任何片段之一匹配成ops片段；
pred：启动该匹配的前置条件代码，输出布尔变量。该代码片段生成于XXXGenDAGISel.inc中，代码片段除了可以访问class XXXDAGToDAGISel，还可以访问一个临时变量SDNode *N；
xform：对节点的转换代码片段，类型为SDNodeXForm。默认为NOOP_SDNodeXForm，即不转换。
</code></pre>
<p>注：PatFrags本质上是模式匹配的宏（类似c中的宏定义），只有代入pat中才会展开其功能。通常frags只有一项，因此td模板定义了PatFrag来表示这种情况。</p>
<p>class SDNodeXForm用于对节点的转换操作，例如在PatFrags匹配结束，基于匹配的SDNode构造上级pat匹配结果的操作数、或者做封装、甚至替换。此外，SDNodeXForm还会出现在dag匹配片段中。核心字段如下：</p>
<pre><code class="language-c++">opc：可转换的节点，类型为SDNode。
xformFunction：转换代码片段，代码片段除了可以访问class XXXDAGToDAGISel，还可以访问一个临时变量SDNode *N；
</code></pre>
<h2 id="1-immleaf">.1 ImmLeaf</h2>
<p>ImmLeaf表示将一个常数叶子重新匹配、或者说重定义为一个新的节点，也就是立即数节点。用于取立即数操作。立即数节点是没有子节点可继续展开，所以在PatFrag中断ops参数由一个空的ops表示。其主要两个参数：</p>
<pre><code class="language-c++">vt：表示节点的输出类型，例如i8、i16、i32等；
pred：表示可匹配的先决条件，为一段输出布尔的代码。代码片段除了可以访问class XXXDAGToDAGISel，还可以访问一个临时变量 Imm
</code></pre>
<h3 id="2-patleaf">.2 PatLeaf</h3>
<p>PatLeaf表示将一个无操作数节点重新匹配、或者说重定义为一个新的节点名称，PatLeaf是PatFrag子类。由于叶子节点没有子节点可继续展开，所以在PatFrag中断ops参数由一个空的ops表示。例如x86中如下定义：</p>
<pre><code class="language-c++">... ...
def i32immSExt8  : ImmLeaf&lt;i32, [{ return isInt&lt;8&gt;(Imm); }]&gt;;
... ...
def i32immSExt8_su : PatLeaf&lt;(i32immSExt8), [{
    return !shouldAvoidImmediateInstFormsForSize(N);
}]&gt;;
... ...

</code></pre>
<p>注：与PatFrag类似，pred字段的代码片段除了可以访问class XXXDAGToDAGISel，还可以访问一个临时变量SDNode *N。</p>
<h1 id="4-complexpattern">4 ComplexPattern</h1>
<p>ComplexPattern可用于从节点中提前操作数。例如地址有基地址、偏移、scale等组成，这时ComplexPattern派上用场。其各个字段意义如下：</p>
<pre><code class="language-c++">Ty：被提取、或者说匹配的节点类型；
NumOperands：需要提前的子操作数个数；
SelectFunc：表示class XXXDAGToDAGISel中用于提取操作的成员函数名称；
RootNodes：表示该提取操作在哪些根节点下有效。为空则没有限制；
Properties：表示被提取节点(而非根节点)的属性；
</code></pre>
<p>例如X86中，有如下定义：</p>
<pre><code class="language-c++">def addr      : ComplexPattern&lt;iPTR, 5, &quot;selectAddr&quot;, [], [SDNPWantParent]&gt;;
</code></pre>
<p>则X86DAGToDAGISel类中有如下函数实现：</p>
<pre><code class="language-c++">//Parent - ComplexPattern中定义了SDNPWantParent属性；
//N - 被提取节点，类型为iPTR；
//后面的导出参数对应ComplexPattern中定义的5个需要提前的子操作数
bool X86DAGToDAGISel::selectAddr(SDNode *Parent, SDValue N, SDValue &amp;Base,
                                 SDValue &amp;Scale, SDValue &amp;Index,
                                 SDValue &amp;Disp, SDValue &amp;Segment) {
</code></pre>
<h1 id="5">5. 谓词条件</h1>
<p>谓词条件表示匹配或定义有效的前置条件。除了前面各个record中表示谓词的字段。还有一种定义谓词的通用方式，就是def的record多重继承class Requires&lt; list &lt; Predicate &gt; preds &gt;。其中Predicate定义的谓词一般访问Subtarget实现返回条件布尔值。</p>
<h2 id="_3">模式匹配</h2>
<h3 id="61-dag">6.1 dag的组成</h3>
<p>在模式匹配中，由节点、操作数、输出三者组成一个dag单元；一个匹配的dag由一个dag单元组成、或多个dag单元嵌套组成。</p>
<pre><code class="language-c++">节点的组成：Instruction、SDNode、PatFrags和它们的派生类型组成；
操作数的组成：除了可以由组成节点的类型组成外；可以由ComplexPattern、SDNodeXForm、Operand以及Operand的派生类型组成；还可以由具体的值(如0、1、。。。)、ValueType的派生类型、RegisterClass、具体的Register组成；另外操作数还可以由一个dag单元组成，用于复杂的dag嵌套；
输出的组成：一般可以不提供，它通常由set指定，由RegisterClass、具体的Register组成。
</code></pre>
<p>注：特别地，ValueType的派生类型可以显示声明操作数的数据类型和节点输出的数据类型。</p>
<p>此外，llvm还提供了一些特殊的def，也是dag组成的元素。</p>
<pre><code class="language-c++">unknown：表示节点的操作数、输出值是一个不可知的任意可能的输入/输出；
node：表示组成节点单位的任意元素。通常用在PatFrags和它们的派生类型组成中；
set：用于声明节点输出；
implicit：用于声明dag隐式读取或修改某个寄存器；
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../js/base.js"></script>
        <script src="../../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
