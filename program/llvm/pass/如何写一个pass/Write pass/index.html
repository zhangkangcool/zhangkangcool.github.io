<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../../img/favicon.ico">
        <title>Write pass - My Docs</title>
        <link href="../../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../wiki/summary/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../%E5%A6%82%E4%BD%95%E5%86%99%E4%B8%80%E4%B8%AApass/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            
            
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<pre><code class="language-cpp">/// FunctionPass class - This class is used to implement most global
/// optimizations.  Optimizations should subclass this class if they meet the
/// following constraints:
///
///  1. Optimizations are organized globally, i.e., a function at a time
///  2. Optimizing a function does not cause the addition or removal of any
///     functions in the module
///
class FunctionPass : public Pass

//===----------------------------------------------------------------------===//
/// ModulePass class - This class is used to implement unstructured
/// interprocedural optimizations and analyses.  ModulePasses may do anything
/// they want to the program.
///
class ModulePass : public Pass


class LoopPass : public Pass 
class MachineFunctionPass : public FunctionPass

/// ImmutablePass class - This class is used to provide information that does
/// not need to be run.  This is useful for things like target information and
/// &quot;basic&quot; versions of AnalysisGroups.
///
class ImmutablePass : public ModulePass {
</code></pre>
<p>所有的pass大致可以分为两类：分析和转换分析类的pass以提供信息为主，转换类的会修改中间代码。</p>
<p>这个Pass 可以操作整个module  是以文件进行区分的。ModulePass 可以操作Module 下的大部分 基本是万能的但是不是最方便的。我们需要根据需要选择 FunctionPass  LoopPass 等</p>
<p>最后一个参数判断是否是分析pass，在Analysis下面的pass，基本都是分析pass。</p>
<p>analysis是true，则为分析pass。</p>
<pre><code> #define INITIALIZE_PASS(MyPassName, arg, name, cfg, analysis)     # 使用宏来生成 initializeMyPassNamePass
</code></pre>
<p>分析pass，可以通过下面的代码获得分析有结果，非分析pass不能这么干。</p>
<pre><code>LiveVariables *LV = getAnalysisIfAvailable&lt;LiveVariables&gt;();
</code></pre>
<p>分析pass有两种，一种是必须的，另一种是非必须的。</p>
<h3 id="1-pass">1. 必须的分析pass</h3>
<p><code>EarlyIfConversion.cpp</code> 该pass必须知道<code>MachineBranchProbabilityInfo</code></p>
<pre><code class="language-c++">970 INITIALIZE_PASS_DEPENDENCY(MachineDominatorTree)
 971 INITIALIZE_PASS_DEPENDENCY(MachineBranchProbabilityInfo)
 972 INITIALIZE_PASS_END(EarlyIfPredicator, DEBUG_TYPE, &quot;Early If Predicator&quot;, false,
 973                     false)
 974
 975 void EarlyIfPredicator::getAnalysisUsage(AnalysisUsage &amp;AU) const {
 976   AU.addRequired&lt;MachineBranchProbabilityInfo&gt;();
 977   AU.addRequired&lt;MachineDominatorTree&gt;();
 978   AU.addPreserved&lt;MachineDominatorTree&gt;();
 979   AU.addRequired&lt;MachineLoopInfo&gt;();
 980   AU.addPreserved&lt;MachineLoopInfo&gt;();
 981   MachineFunctionPass::getAnalysisUsage(AU);
 982 }


1038 bool EarlyIfPredicator::runOnMachineFunction(MachineFunction &amp;MF) {

1050   Loops = getAnalysisIfAvailable&lt;MachineLoopInfo&gt;();
1051   MBPI = &amp;getAnalysis&lt;MachineBranchProbabilityInfo&gt;();
}


</code></pre>
<h3 id="2-pass">2 非必须pass</h3>
<pre><code>getAnalysisIfAvailable 一般用于已经有了，则进行更新

</code></pre>
<p>保留传给下一个Pass</p>
<pre><code>AU.addPreserved&lt;LiveVariables&gt;();
</code></pre>
<p><code>AU.addRequired</code>还有DEPENDENCY的话，LiveVarialbles一定会支持。</p>
<p>但<code>AU.addUsedIfAvailable&lt;LiveVariables&gt;();</code>则需要runpass的时候，手工运行livevars pass。</p>
<pre><code class="language-c++">131 INITIALIZE_PASS_BEGIN(PHIElimination, DEBUG_TYPE,
132                       &quot;Eliminate PHI nodes for register allocation&quot;,
133                       false, false)
134 INITIALIZE_PASS_DEPENDENCY(LiveVariables)
135 INITIALIZE_PASS_END(PHIElimination, DEBUG_TYPE,
136                     &quot;Eliminate PHI nodes for register allocation&quot;, false, false)
137
138 void PHIElimination::getAnalysisUsage(AnalysisUsage &amp;AU) const {
139 //  AU.addUsedIfAvailable&lt;LiveVariables&gt;();
140   AU.addRequired&lt;LiveVariables&gt;();
141   AU.addPreserved&lt;LiveVariables&gt;();
142 //  AU.addPreserved&lt;SlotIndexes&gt;();
143   AU.addPreserved&lt;LiveIntervals&gt;();
144   AU.addPreserved&lt;MachineDominatorTree&gt;();
145   AU.addPreserved&lt;MachineLoopInfo&gt;();
146   MachineFunctionPass::getAnalysisUsage(AU);
147 }
148
</code></pre>
<pre><code class="language-c++">  template&lt;class PassClass&gt;
  AnalysisUsage &amp;addUsedIfAvailable() {
    Used.push_back(&amp;PassClass::ID);
    return *this;
  }


</code></pre>
<pre><code class="language-c++">  /// Sets of analyses required and preserved by a pass
  // TODO: It's not clear that SmallVector is an appropriate data structure for
  // this usecase.  The sizes were picked to minimize wasted space, but are
  // otherwise fairly meaningless.
  SmallVector&lt;AnalysisID, 8&gt; Required;
  SmallVector&lt;AnalysisID, 2&gt; RequiredTransitive;
  SmallVector&lt;AnalysisID, 2&gt; Preserved;
  SmallVector&lt;AnalysisID, 0&gt; Used
</code></pre>
<pre><code class="language-c++">      ProfileVec(AU.getRequiredSet());
      ProfileVec(AU.getRequiredTransitiveSet());
      ProfileVec(AU.getPreservedSet());
      ProfileVec(AU.getUsedSet());


    // Return true if P preserves high level analysis used by other
// passes managed by this manager
bool PMDataManager::preserveHigherLevelAnalysis(Pass *P) {
  AnalysisUsage *AnUsage = TPM-&gt;findAnalysisUsage(P);
  if (AnUsage-&gt;getPreservesAll())
    return true;

  const AnalysisUsage::VectorType &amp;PreservedSet = AnUsage-&gt;getPreservedSet();
  for (Pass *P1 : HigherLevelAnalysis) {
    if (P1-&gt;getAsImmutablePass() == nullptr &amp;&amp;
        !is_contained(PreservedSet, P1-&gt;getPassID()))
      return false;
  }

  return true;
}
</code></pre>
<p>重新计算：// MachineVerifier 可做此修改</p>
<pre><code class="language-c++"> 375 //      LiveVars = PASS-&gt;getAnalysisIfAvailable&lt;LiveVariables&gt;();
 376       LiveVars = &amp;PASS-&gt;getAnalysis&lt;LiveVariables&gt;();

 286     void getAnalysisUsage(AnalysisUsage &amp;AU) const override {
 287       AU.setPreservesAll();
 288       AU.addRequired&lt;LiveVariables&gt;();
 289       MachineFunctionPass::getAnalysisUsage(AU);
          }
</code></pre>
<p>有则使用：</p>
<pre><code class="language-c++">138 void PHIElimination::getAnalysisUsage(AnalysisUsage &amp;AU) const {
139   AU.addUsedIfAvailable&lt;LiveVariables&gt;();
140 //  AU.addRequired&lt;LiveVariables&gt;();
141   AU.addPreserved&lt;LiveVariables&gt;();
147 }
148
149 bool PHIElimination::runOnMachineFunction(MachineFunction &amp;MF) {
151   LV = getAnalysisIfAvailable&lt;LiveVariables&gt;();
152   if (LV)
153     dbgs() &lt;&lt; __LINE__ &lt;&lt; &quot; zhangkang LV is not empty.\n&quot;;
154   else
155     dbgs() &lt;&lt; __LINE__ &lt;&lt; &quot; zhangkang LV is empty.\n&quot;;
</code></pre>
<p>分析pass不能改变指令和CFG等。</p>
<h3 id="_1">分类</h3>
<p>https://llvm.org/docs/Passes.html</p>
<p>https://blog.csdn.net/qq_23599965/article/details/88344459</p>
<p>Analysis passes： compute information that other passes can use or for debugging or program visualization purposes. Transform passes： can use (or invalidate) the analysis passes. Transform passes all mutate the program in some way. Utility passes： provides some utility but don't otherwise fit categorization. For example passes to extract functions to bitcode or write a module to bitcode are neither analysis nor transform passes.</p>
<p>在LLVM中优化以pass形式实现, 每一个pass代表一种优化. pass分为两类, 一类是分析(analysis)pass, 负责收集信息共其它pass使用, 辅助调试或使程序可视化; 另一类是变换(transform)pass, 改变程序的dataflow / controlflow. LLVM中实现了几十种优化pass, 其中许多pass运行不止一次. analysis pass存放在lib/Analysis下, transform pass存放在lib/Transforms下. </p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../../js/base.js"></script>
        <script src="../../../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
