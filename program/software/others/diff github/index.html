<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../img/favicon.ico">
        <title>Compare output of WYC and XLC - My Docs</title>
        <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../clang-format/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../pipestat/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#compare-output-of-wyc-and-xlc" class="nav-link">Compare output of WYC and XLC</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#1-the-result-info" class="nav-link">1 The result info</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#11-result_inst_num" class="nav-link">1.1 result_inst_num</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#12-log-files" class="nav-link">1.2 Log files</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#2-scripts" class="nav-link">2 Scripts</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#21-reproduceimportant" class="nav-link">2.1 reproduce(important)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#22-generate_c" class="nav-link">2.2 generate_c</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#23-compare" class="nav-link">2.3 compare</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#24-merge_result" class="nav-link">2.4 merge_result</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#25-comparators" class="nav-link">2.5 comparators/</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#26-multi_dir" class="nav-link">2.6 multi_dir/</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#3-how-to-mark-the-case" class="nav-link">3 How to mark the case</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="compare-output-of-wyc-and-xlc">Compare output of WYC and XLC</h1>
<h4 id="the-old-shell-script-result-is-in-the-branch-shell_script">The old shell script &amp; result is in the branch <code>shell_script</code>.</h4>
<hr />
<h1 id="1-the-result-info">1 The result info</h1>
<h2 id="11-result_inst_num">1.1 result_inst_num</h2>
<p>This dir contains the log files and c files.</p>
<p>For example:</p>
<pre><code class="language-shell">ls result_inst_num/CodeGen
cfiles/  log/
</code></pre>
<p>The result_inst_num result is get by using the <code>comparators/compare_num_inst_ops</code>.</p>
<h2 id="12-log-files">1.2 Log files</h2>
<p>Every log dir has 6 log files, for example <code>result_inst_num/Transforms/log/ADCE</code>:</p>
<pre><code class="language-shell">ls result_inst_num/Transforms/log/ADCE
compare.error.log  compare.log  generate_c.error.log  generate_c.log  merge_result.error.log  merge_result.log
</code></pre>
<ul>
<li>
<p>generate_c.error.log: The err  info how we transfer ll:func file to the hash.c., you needn't care about it.</p>
</li>
<li>
<p>compare.error.log: The err info when comparing the xlc dis with wyc dis. , you needn't care about it.</p>
</li>
<li>
<p>merge_result.error.log:  The err info when merge generate_c.log and comapre.log , you needn't care about it.</p>
</li>
<li>
<p>generate_c.log: The info how we transfer ll:func file to the hash.c. Below is an example:</p>
</li>
</ul>
<p><code>shell
  /home/ken/llvm/llvm/test/Transforms/ADCE/2002-05-28-Crash-distilled.ll:test -&gt; /home/ken/diff_clang_xl/result_inst_num/Transforms/cfiles/ADCE/26924449f5e59c9aeb6e82bf2bf452a1f59e05d5.c</code></p>
<ul>
<li>compare.log: The info when comparing the xlc dis with wyc dis. The log only records the wyc worse case. Below is an example:</li>
</ul>
<p><code>shell
  /home/ken/diff_clang_xl/result_inst_num/Transforms/cfiles/ADCE/26924449f5e59c9aeb6e82bf2bf452a1f59e05d5.c: wyc worse  WYC: /xl_le/compgpfs/builds/rings/ppc64le/rhel7/wyvern.dev.release/ring.good/latest/bin/clang -O2 -Ofast -mcpu=pwr9 -c /home/ken/diff_clang_xl/result_inst_num/Transforms/cfiles/ADCE/26924449f5e59c9aeb6e82bf2bf452a1f59e05d5.c -o /tmp/tmppfok7e_o
  XLC: /xl_le/gsa/tlbgsa/projects/x/xlcmpbld/run/clangtana/16.1.1/linux_leppc/daily/latest/bin/xlc -O2 -Ofast -mcpu=pwr9 -c /home/ken/diff_clang_xl/result_inst_num/Transforms/cfiles/ADCE/26924449f5e59c9aeb6e82bf2bf452a1f59e05d5.c -o /tmp/tmptydskg1k
  WYC has 6 instructions, XLC has 5 instructions.
  WYC has more 1 instructions than XLC(20.00%).</code></p>
<ul>
<li>merge_result.log:  The info when merge generate_c.log and comapre.log , you don't care about it.</li>
</ul>
<p>Above case, we will get:</p>
<p><code>shell
  /home/ken/llvm/llvm/test/Transforms/ADCE/2002-05-28-Crash-distilled.ll:test: wyc worse
  WYC has 6 instructions, XLC has 5 instructions.
  WYC has more 1 instructions than XLC(20.00%).</code></p>
<p>Then, you can use the <code>reprodece</code> script to reproduce the issue.</p>
<hr />
<h1 id="2-scripts">2 Scripts</h1>
<h2 id="21-reproduceimportant">2.1 reproduce(important)</h2>
<pre><code class="language-shell">usage: reproduce [-h] --ir_filename IR_FILENAME --func FUNC --out OUT
                 --custom_compare CUSTOM_COMPARE --compare COMPARE

Generate the C file and reproduce the compare

optional arguments:
  -h, --help            show this help message and exit
  --ir_filename IR_FILENAME
                        The IR filename
  --func FUNC           The func to be tested in the ir_filename
  --out OUT             Output directory
  --custom_compare CUSTOM_COMPARE
                        Script to compare output assembly of wyc and xlc
  --compare COMPARE     Script to use the C file
</code></pre>
<p>This file can using the ll file and func name to extract the ll file, and get the c file, and assembly file.</p>
<p>For example, in 1.2 you have seen below log:</p>
<pre><code class="language-shell">/home/ken/llvm/llvm/test/Transforms/ADCE/2002-05-28-Crash-distilled.ll:test: wyc worse
WYC has 6 instructions, XLC has 5 instructions.
WYC has more 1 instructions than XLC(20.00%).
</code></pre>
<p>You will use below command to get the ll file, c file, assemlby file for the case: <code>2002-05-28-Crash-distilled.ll:test</code>.</p>
<pre><code class="language-shell">/home/ken/diff_clang_xl/scripts/reproduce --ir_filename /home/ken/llvm/llvm/test/Transforms/ADCE/2002-05-28-Crash-distilled.ll --func test --out result/

The result is in result/test
./test/test.bc
./test/test.ll
./test/test.c
./test/test_compare.log
</code></pre>
<p>In the cureent result dir, you will get:</p>
<pre><code class="language-shell">ls test/
test.bc  test.c  test_compare.log  test.ll  wyc.out  xlc.out
</code></pre>
<h2 id="22-generate_c">2.2 generate_c</h2>
<pre><code class="language-shell">usage: generate_c [-h] [-j J] -i I --out OUT [-m M] [--report_error]

Generate c code via LLVM C Backend

optional arguments:
  -h, --help      show this help message and exit
  -j J            Number of threads
  -i I            Input directory to search bitcode and IR files
  --out OUT       Output directory
  -m M            Output manifest filename
  --report_error
</code></pre>
<p>This script is used to generate c code from LLVM IR via <code>llvm-cbe</code>.</p>
<p>For example, I can use below command to get the c files for <code>Transforms/ADCE</code>.</p>
<pre><code class="language-shell">~/diff_clang_xl/scripts/generate_c -j 64 -i ~diff_clang_xl/test/Transforms/ADCE --out ~/diff_clang_xl/result_inst_num/Transforms/cfiles/ADCE -m ~/diff_clang_xl/result_inst_num/Transforms/log/ADCE/generate_c.log &gt; ~/diff_clang_xl/result_inst_num/Transforms/log/ADCE/generate_c.error.log 2&gt;&amp;1
</code></pre>
<h2 id="23-compare">2.3 compare</h2>
<pre><code class="language-shell">usage: compare [-h] [-j J] -i I [-m M] [--report_error] --custom_compare
               CUSTOM_COMPARE [--filter_worse FILTER_WORSE]
               [--filter_better FILTER_BETTER] [--skip_wyc_won]

Compare wyc and xlc

optional arguments:
  -h, --help            show this help message and exit
  -j J                  Number of threads
  -i I                  Input directory to search c code files
  -m M                  Output manifest filename
  --report_error
  --custom_compare CUSTOM_COMPARE
                        Script to compare output assembly of wyc and xlc
  --filter_worse FILTER_WORSE
                        Directory to contain cases wyc get worse result
  --filter_better FILTER_BETTER
                        Directory to contain cases wyc get better result
  --skip_wyc_won
</code></pre>
<p>This script is used to compare the output assembly of wyc and xlc.</p>
<p>User should implement the <code>custom_compare</code> to define what output is good.</p>
<p>For example, I can use below command to get the compare result for <code>Transforms/ADCE</code>.</p>
<pre><code>~/diff_clang_xl/scripts/compare --skip_wyc_won -i ~/diff_clang_xl/result_inst_num/Transforms/cfiles/ADCE --custom_compare ~/diff_clang_xl/scripts/comparators/compare_num_inst_ops -m ~/diff_clang_xl/result_inst_num/Transforms/log/ADCE/compare.log &gt; ~/diff_clang_xl/result_inst_num/Transforms/log/ADCE/compare.error.log 2&gt;&amp;1
</code></pre>
<h2 id="24-merge_result">2.4 merge_result</h2>
<pre><code class="language-shell">usage: merge_result [-h] --generate_log GENERATE_LOG --compare_log COMPARE_LOG
                    [--output OUTPUT]

Merge the output of generate_c and compare

optional arguments:
  -h, --help            show this help message and exit
  --generate_log GENERATE_LOG
                        The log file of generate_c script
  --compare_log COMPARE_LOG
                        The log file of compare script
  --output OUTPUT       Output merge filename
</code></pre>
<p>This script is used to merge the output of generate_c and compare.</p>
<p>For example, I can use the generate_c.log in 2.1 and compare.log in 2.2 by using below command:</p>
<pre><code class="language-shell">./merge_result --generate_log ~/diff_clang_xl/result_inst_num/Transforms/log/ADCE/generate_c.log --compare_log ~/diff_clang_xl/result_inst_num/Transforms/log/ADCE/compare.log  --output ~/diff_clang_xl/result_inst_num/Transforms/log/ADCE/merge_result.log &gt; ~/diff_clang_xl/result_inst_num/Transforms/log/ADCE/merge_result.error.log 2&gt;&amp;1
</code></pre>
<h2 id="25-comparators">2.5 comparators/</h2>
<p>This dir contains the script how the xlc.dis compare with wyc.dis. If will be a parameter used by <code>compare --custom_compare</code>.</p>
<h2 id="26-multi_dir">2.6 multi_dir/</h2>
<pre><code class="language-shell">ls multi_dir/
compare_multi_dir*  generate_multi_dir*  merge_result_multi_dir*
</code></pre>
<p>In general, you will not use the script. Above three script is a wrap for <code>compare</code>,  <code>generat</code>, and  <code>merge_result</code>.  But is can support multi dirs.</p>
<p>The <code>multi_dir</code> version script will search the dir which contains sub-dir, and then call <code>non-mul_dir</code> version script.</p>
<p>In fact, I get the result in <code>result_inst_num/Transforms</code> by using below command.</p>
<h4 id="1-using-generate_multi_dir-get-the-cfiles">1 Using  <code>generate_multi_dir</code> get the cfiles</h4>
<p><code>shell
./generate_multi_dir -i ~/llvm/llvm/test/Transforms --cfiles_out_dir /home/ken/diff_clang_xl/result_inst_num/Transforms/cfiles --log_out_dir /home/ken/diff_clang_xl/result_inst_num/Transforms/log --generate_c /home/ken/diff_clang_xl/scripts/generate_c -j 64</code></p>
<h4 id="2-using-compare_multi_dir-get-the-compare-result">2 Using  <code>compare_multi_dir</code> get the compare result</h4>
<pre><code class="language-shell">./compare_multi_dir -i /home/ken/diff_clang_xl/result_inst_num/Transforms/cfiles --custom_compare comparators/compare_num_inst_ops --log_out_dir /home/ken/diff_clang_xl/result_inst_num/Transforms/log --compare /home/ken/diff_clang_xl/scripts/compare --custom_compare comparators/compare_num_inst_ops -j64
</code></pre>
<h4 id="3-usingmerge_result_multi_dir-to-merge-the-generate_multi_dir-log-and-compare_multi_dir-log">3 Using<code>merge_result_multi_dir</code> to merge the generate_multi_dir log and compare_multi_dir log</h4>
<pre><code class="language-shell">./merge_result_multi_dir --merge_result ~/diff_clang_xl/scripts/merge_result -i /home/ken/diff_clang_xl/result_inst_num/Transforms/log
</code></pre>
<hr />
<h1 id="3-how-to-mark-the-case">3 How to mark the case</h1>
<h3 id="31-use-the-pattern-script-to-mark-the-case">3.1 Use the pattern script to mark the case</h3>
<p>Below command will add <code>has_cmpwi</code> in the end of the log line, if the script <code>has_cmpwi</code> return 0.</p>
<pre><code class="language-shell">./mark_case --log_dirs /home/ken/diff_clang_xl/result_inst_num/tools/ --custom_pattern pattern/has_cmpwi --mark_info has_cmpwi
</code></pre>
<p>Below is the result after run above command:</p>
<pre><code class="language-shell">git diff ../result_inst_num/tools/log/merge_result.log
diff --git a/result_inst_num/tools/log/merge_result.log b/result_inst_num/tools/log/merge_result.log
index 2b6ed6b..445aa8c 100644
--- a/result_inst_num/tools/log/merge_result.log
+++ b/result_inst_num/tools/log/merge_result.log
@@ -6,7 +6,7 @@ WYC has more 38 instructions than XLC(92.00%).
 WYC has 165 instructions, XLC has 44 instructions.
 WYC has more 121 instructions than XLC(275.00%).

-/home/ken/llvm/llvm/test/tools/gold/X86/opt-level.ll:bar: wyc worse
+/home/ken/llvm/llvm/test/tools/gold/X86/opt-level.ll:bar: wyc worse #has_cmpwi
 WYC has 5 instructions, XLC has 4 instructions.
 WYC has more 1 instructions than XLC(25.00%).
</code></pre>
<h3 id="32-manual">3.2 Manual</h3>
<p>If you have anayze the case or open the issue for it, you should mark it to avoid others do the same work.</p>
<p>In the file<code>~/diff_clang_xl/result_inst_num/CodeGen/log/PowerPC/merge_result.log</code>, you can see below info:</p>
<pre><code class="language-shell">2261 /home/ken/llvm/llvm/test/CodeGen/PowerPC/f128-vecExtractNconv.ll:uhwVecConv2qp5: wyc worse #142
2262 WYC has 34 instructions, XLC has 15 instructions.
2263 WYC has more 19 instructions than XLC(126.00%).
</code></pre>
<p>It shows that this case has been analyzed in the issue 142.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../js/base.js"></script>
        <script src="../../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
