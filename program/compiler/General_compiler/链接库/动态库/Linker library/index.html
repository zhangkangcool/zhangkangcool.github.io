<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../../../img/favicon.ico">
        <title>Linker library - My Docs</title>
        <link href="../../../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../../../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../../asm%20%26%20linker/llvm%20asm/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../fPIC/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="2"><a href="#search-path" class="nav-link">Search Path</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#-ldir" class="nav-link">-LDir</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#-ldir-wl-rpathdir" class="nav-link">-LDir -Wl,-rpath,Dir</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="search-path">Search Path</h2>
<p>https://blog.csdn.net/ibingow/article/details/7882098
https://gcc.gnu.org/ml/gcc-help/2005-12/msg00017.html</p>
<pre><code>Unless loading object has RUNPATH:
    RPATH of the loading object,
        then the RPATH of its loader (unless it has a RUNPATH), ...,
        until the end of the chain, which is either the executable
        or an object loaded by dlopen(loader 为可执行程序或被 dlopen 打开的对象)
    Unless executable has RUNPATH:
        RPATH of the executable
LD_LIBRARY_PATH
RUNPATH of the loading object
ld.so.cache
default dirs
</code></pre>
<p>gcc编译链接动态库时，很有可能编译通过，但是执行时，找不到动态链接库，那是
因为-L选项指定的路径只在编译时有效，编译出来的可执行文件不知道-L选项后面的值，当然找不到。可以用ldd <your_execute>看看是不有 ‘not found’在你链接的库后面，解决方法是在编译时使用<code>-Wl,rpath=&lt;your_lib_dir&gt;</code>，使得execute记住链接库的位置.</p>
<p><code>-LDir</code>是编译时指定的路径，但运行时，EXE并不知道该路径，运动时使用系统路径，或是<code>$LD_LIBRARY_PATH</code>指定的路径。
如果想运行时指定库的位置，编译时可以使用<code>-LDir -Wl -rpath=Dir</code>或是<code>-LDir -Wl,rpath,Dir</code>，这样运行时就不需要再使用<code>LD_LIBRARY_PATH</code>了。</p>
<p>二进制程序被链接时由参数-rpath指定的运行时目录，多个则以冒号分隔。这个是被硬编码进二进制程序的，包括可执行程序和动态库，都可以有这个-rpath.</p>
<p>运行时动态库的搜索顺序：</p>
<pre><code>1. 二进制程序被链接时由参数-rpath指定的运行时目录，多个则以冒号分隔。这个是被硬编码进二进制程序的，包括可执行程序和动态库，都可以有这个-rpath.
2.环境变量LD_LIBRARY_PATH指定的目录，多个则以冒号分隔。
3.系统里/etc/ld.so.conf文件里指定的目录。
4.系统里动态库加载器ld-linux.so（ldd命令实际调用的还是这个）默认的搜索目录/lib,usr/lib或者/lib64,/usr/lib64。
</code></pre>
<p><code>-Wl</code>:告诉编译器将后面的参数传递给链接器。</p>
<p>例如：</p>
<pre><code>cat test.cpp

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
int main() {
//    malloc(10);
    return 0;
}
</code></pre>
<h1 id="-ldir">-LDir</h1>
<pre><code>xlc -ltcmalloc test.cpp -L/opt/at12.0/lib64
./a.out
./a.out: error while loading shared libraries: libtcmalloc.so.4: cannot open shared object file: No such file or directory
ldd a.out
    linux-vdso64.so.1 =&gt;  (0x00007ffff7f80000)
    libtcmalloc.so.4 =&gt; not found
    libgcc_s.so.1 =&gt; /lib/powerpc64le-linux-gnu/libgcc_s.so.1 (0x00007ffff7f20000)
    libm.so.6 =&gt; /lib/powerpc64le-linux-gnu/libm.so.6 (0x00007ffff7de0000)
    libc.so.6 =&gt; /lib/powerpc64le-linux-gnu/libc.so.6 (0x00007ffff7bf0000)
    /lib64/ld64.so.2 (0x00007ffff7fa0000)
</code></pre>
<p>此种情况，需要将<code>/opt/at12.0/lib64</code>加入系统路径或是用LD_LIBRARY_PATH</p>
<h1 id="-ldir-wl-rpathdir">-LDir -Wl,-rpath,Dir</h1>
<p>这里编译时记住了库所在的路径，所以不需要个性<code>LD_LIBRARY_PATH</code>即可运行。</p>
<pre><code>xlc -ltcmalloc test.cpp -L/opt/at12.0/lib64 -Wl,-rpath=/opt/at12.0/lib64
ldd a.out
    linux-vdso64.so.1 =&gt;  (0x00007ffff7f80000)
    libtcmalloc.so.4 =&gt; /opt/at12.0/lib64/libtcmalloc.so.4 (0x00007ffff7dd0000)
    libgcc_s.so.1 =&gt; /opt/at12.0/lib64/power9/libgcc_s.so.1 (0x00007ffff7d90000)
    libm.so.6 =&gt; /opt/at12.0/lib64/power9/libm.so.6 (0x00007ffff7c50000)
    libc.so.6 =&gt; /opt/at12.0/lib64/power9/libc.so.6 (0x00007ffff7a10000)
    libpthread.so.0 =&gt; /opt/at12.0/lib64/power9/libpthread.so.0 (0x00007ffff79c0000)
    libstdc++.so.6 =&gt; /opt/at12.0/lib64/power9/libstdc++.so.6 (0x00007ffff7770000)
    /lib64/ld64.so.2 (0x00007ffff7fa0000)

./a.out // work well
</code></pre>
<h3 id="-l-l-l-l">-l (小写的L)<strong>参数和</strong>-L (大写的L)参数</h3>
<p>-l 不需要路径，不在系统路径中的其它路径由-L指定</p>
<p><strong>-l</strong>参数就是用来<strong>指定程序要链接的库</strong>，<strong>-l</strong>参数紧接着就是库名，那么库名跟真正的库文件名有什么关系呢？
就拿数学库来说，他的库名是m，他的库文件名是lib<strong>m</strong>.so，很容易看出，把库文件名的头lib和尾.so去掉就是库名了。</p>
<p>好了现在我们知道怎么得到库名了，比如我们自已要用到一个第三方提供的库名字叫libtest.so，那么我们只要把libtest.so拷贝到/usr/lib里，编译时加上<strong>-</strong>ltest参数，我们就能用上libtest.so库了（当然要用libtest.so库里的函数，我们还需要与libtest.so配套的头文件）。</p>
<p><strong>放在/lib和/usr/lib和/usr/local/lib里的库直接用-l参数就能链接了</strong>，但如果库文件没放在这三个目录里，而是放在其他目录里，这时我们只用<strong>-l</strong>参数的话，链接还是会出错，出错信息大概是：“/usr/bin/ld: cannot find <strong>-</strong>lxxx”，也就是链接程序ld在那3个目录里找不到libxxx.so，这时<strong>另外一个参数-L就派上用场了</strong>，比如常用的X11的库，它放在/usr/X11R6/lib目录下，我们编译时就要用<strong>-L</strong> /usr/X11R6/lib <strong>-</strong>lX11参数，<strong>-L参数跟着的是库文件所在的目录名</strong>。再比如我们把libtest.so放在/aaa/bbb/ccc目录下，那链接参数就是<strong>-L</strong>/aaa/bbb/ccc <strong>-</strong>ltest</p>
<p>另外，大部分libxxxx.so只是一个链接，以RH9为例，比如libm.so它链接到/lib/libm.so.x，/lib/libm.so.6又链接到/lib/libm<strong>-</strong>2.3.2.so，</p>
<p>如果没有这样的链接，还是会出错，因为ld只会找libxxxx.so，所以如果你要用到xxxx库，而只有libxxxx.so.x或者libxxxx<strong>-</strong>x.x.x.so，做一个链接就可以了ln <strong>-</strong>s libxxxx<strong>-</strong>x.x.x.so libxxxx.so</p>
<p>手工来写链接参数总是很麻烦的，还好很多库开发包提供了生成链接参数的程序，名字一般叫xxxx<strong>-</strong>config，一般放在/usr/bin目录下，比如</p>
<p>cmake中设置编译时路径,运行时可以使用LD_LIBRARY_PATH，或者 rpath把路径在程序中写死</p>
<pre><code>link_directories(/usr/lib)
会编译时自动添加-L,如
gcc -o test test.cpp -L/usr/lib
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../../../js/base.js"></script>
        <script src="../../../../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
